<?xml version="1.0" encoding="UTF-8" ?>
<html>

    <head>    
        <style>            
            
            #map-block {                
                position: absolute;                
                height: 60%;
                width: 95%;
            }

            #mapid { 
                height: 100%;
                width: 70%;
                border: 1px solid #333;
                display: inline-block;
            }

            .inp { height: 10%; }

            .info {
                height: 30px;
                width: 100%;
            }
            #layer-container {
                width: 25%;
                height: 100%;
                border: 1px solid #333;
                position: absolute;
                display: inline-block;
                overflow-y: scroll;
            }
            .layers {
                width: 95%;
                list-style-type: none;
                margin-left:4px;
                padding: 0px;
            }
            .layers label {
                width: 100%;
                border: 1px solid black;
                margin-bottom: 4px;                
                display: block;
                user-select: none;
            }

        </style>
        <!-- Add Leaflet map - https://leafletjs.com/examples/quick-start/ -->

        <link   rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" 
                integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
                crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
                integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
                crossorigin="">
        </script>

        <script>                                    
            var map                                 // Map object            
            var layerData                           // Map points            
            var poly_id = {}                        // Map polyline id - file number mapping            
            var fileList = []                       // Files opened
            var poly = []                           // All poly items
            var hov                                 // Hover tooltip
            
            // var mapLayer                            // Layer for lines
            // var selectedLayer                       // Layer for selected lines
            var polyProps                           // Poly properties

            function init() {
                // Init Leaflet map                
                map = L.map('mapid');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                  
                var parser = new DOMParser();                
                var file_count = 100;                

  				function handleGPX(e) { 
					// fileList.value = this.result; 
                    var coords = [];
                    xmlDoc = parser.parseFromString(this.result,"text/xml");

                    var pt = xmlDoc.getElementsByTagName("trkpt");                                    
                    var lastp = L.latLng(0, 0);                    

                    Array.from(pt).forEach(p =>{
                        let lat = p.getAttribute("lat"),
                            lon = p.getAttribute("lon");
                        
                        newp = L.latLng(lat, lon);

                        if (map.distance(lastp, newp) > minDist.value) {
                            coords.push([lat,lon]);
                            lastp = newp;
                        }
                                                
                    });
                    
                    // let s = L.LineUtil.simplify(coords, maxSimp.value);
                    // layerData.push(simplify(coords));
                    layerData.push(coords);
                    file_count--;
                    if (!file_count) showMap();
				};

                inpFiles.addEventListener("change",function() {                    
                    layerData = []
                    polyProps = []
                    fileList = []

                    poly.forEach(p => {
                        map.removeLayer(p);
                    });

                    if (inpFiles.files) {
                        layers.innerHTML = "";
                        
                        file_count = inpFiles.files.length;

                        Array.from(inpFiles.files).forEach(file => {                                                        
                            fileList.push(file)

                            var li = document.createElement('li');
                            var inp = document.createElement('input');
                            inp.type="checkbox";
                            var lbl = document.createElement('label');
                            
                            lbl.appendChild(inp);
                            lbl.appendChild(document.createTextNode(file.name));
                            li.appendChild(lbl);                            
                            
                            layers.appendChild(li);                        
                            
                            var fr=new FileReader();  
                            fr.readAsText(file);
                            fr.onload = handleGPX;
                        });                                            
                    }                     
                });
            }
            function simplify(arr) {                                
                // Simplify polyline 
                
                function recurse(a, m, n, res) {
                    console.log(`${m}..${n}`);
                    
                    max_dist = a.reduce((t,c,i) => {
                        // Get max distance in [id, dist]
                        // console.log(`${m}..${n}`);                        
                        dist = L.LineUtil.pointToSegmentDistance(L.point(c), L.point(a[m]), L.point(a[n]));
                        if ((dist >= t[1]) & (dist>maxSimp.value/111319)) return [i, dist]; else return t;
                    }, [-1, 0]);

                    let maxd = max_dist[0]
                    // Everything will be simplified.
                    if (maxd == -1) {
                        return res.concat([a[m]],[a[n]]); 
                    } else {
                        return recurse(a, m, maxd, res) +  recurse(a, maxd, n, [])
                    }
                }
                                
                return recurse(arr, 0, arr.length-1, []);
            }
            function selectItem(id) {
                num = poly_id[id]

            }

            function showMap() {     
                poly = []  
                hov =  L.popup()
                .setLatLng(layerData[0][0])
                .setContent('DD')
                .openOn(map);

                function hoverEvent(ev) {
                    let fnum = poly_id[ev.sourceTarget._leaflet_id];
                    hov.setLatLng(ev.latlng)       
                    let fname = polyProps[fnum].name
                    let lastMod = polyProps[fnum].lastMod
                    hov.setContent(`${fname}\n${lastMod}`)
                }   

                function segmentClick(t) {
                    /*
                    min_id = poly.reduce((total,c,i) => {
                        dist = c.closestLayerPoint(L.point(ev.latlng)).distance(ev.latlng)
                        if (dist<t[1]) return [i, dist]; else return t
                    }, [-1, Infinity])
                    
                    if (min_id[1]>100) return

                    t = poly[min_id[0]]
                    */
                    fnum = poly_id[t.sourceTarget._leaflet_id];
                    document.querySelectorAll("li").forEach(l=>{                    
                        l.style.backgroundColor="#EEE";                    
                    });

                    s = !polyProps[fnum].selected
                    polyProps[fnum].selected = s

                    let l = document.querySelector(`li:nth-child(${fnum+1})`)
                    l.style.backgroundColor="#44b";                    
                    l.querySelector('input').checked = s

                    poly[fnum].setStyle({color: s ? 'blue' : 'red' });

                    // Show layer item
                    l.scrollIntoView();
                    
                }
                
                var toleranceRender = L.canvas({ padding: 0.5, tolerance: 20 });

                layerData.forEach((p,i)=> {                    
                    var polyline = L.polyline(p, {color: 'red', renderer: toleranceRender}).addTo(map);

                    polyline.on('click', segmentClick);
                    polyline.on('mouseover', hoverEvent);
                    
                    poly.push(polyline);
                    
                    // Add properties
                    let prop = {                        
                        selected: false
                    }
                    prop.name= fileList[i].name
                    prop.lastMod = fileList[i].lastModifiedDate
                    polyProps.push(prop)

                    poly_id[polyline._leaflet_id] = i;
                    
                });
                
                // zoom the map to include all polylines
                let zoomOut = null;
                poly.forEach(p=>{
                    if (zoomOut == null) {
                        zoomOut = p.getBounds()
                    } else {
                        let b = p.getBounds();
                        let b0 = b._northEast;
                        let b1 = b._southWest;
                        b0 = L.latLng (Math.max(b0.lat, zoomOut._northEast.lat), Math.max(b0.lng, zoomOut._northEast.lng));
                        b1 = L.latLng (Math.min(b1.lat, zoomOut._southWest.lat), Math.min(b1.lng, zoomOut._southWest.lng));
                        zoomOut = L.latLngBounds(b0, b1);                        
                    }                    
                });

                map.fitBounds(zoomOut);
                info.innerHTML=`${layerData.length} files, ${layerData.reduce((t,c)=>t+c.length,0)} coordinates shown.`;                
            }
        </script>
    </head>    
    <body onload="init()">
        <div>
            <input type="file" class="inp" id=inpFiles multiple/><br>
            <input type="number" id=minDist value="5"/>
            <label for=minDist>meters min dist</label>

            <input type="number" id=maxSimp value="10"/> meters simplify<br>
            <span id=info class="info"></span>
        </div>
        
        <div id="map-block">
            <div id="mapid"></div>
            <div id="layer-container">
                <ul class="layers" id=layers>
                    <li>
                        <label>
                            <input type="checkbox"/>
                            No files opened yet...
                        </label>
                    </li>
                </ul>
            </div>
        </div>        
    </body>
</html>
