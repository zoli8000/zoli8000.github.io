var Yt=Object.defineProperty;var Qt=(t,e,r)=>e in t?Yt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var a=(t,e,r)=>(Qt(t,typeof e!="symbol"?e+"":e,r),r);import{C as Zt,K as jt,B as Gt}from"./roms-990e598c.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function r(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=r(i);fetch(i.href,n)}})();class ct{constructor(e,r,s,i){a(this,"mem_8000");a(this,"mem_a000");a(this,"mem_d000");a(this,"mem_e000");this.mem_8000=e,this.mem_a000=r,this.mem_d000=s,this.mem_e000=i}setMemMode(e,r,s,i){this.mem_8000=e,this.mem_a000=r,this.mem_d000=s,this.mem_e000=i}}const y={FULL_RAM:new ct(0,0,0,0),RAM_IO:new ct(0,0,1,0),RAM_RAM_RAM_RAM:[0,0,0,0],RAM_CART_CHR_ROM:[0,3,2,2],CART_CART_CHR_ROM:[3,3,2,2],RAM_RAM_IO_RAM:[0,0,1,0],RAM_CART_IO_ROM:[0,3,1,2],CART_CART_IO_ROM:[3,3,1,2],RAM_RAM_CHR_RAM:[0,0,2,0],RAM_RAM_CHR_ROM:[0,0,2,2],CART_ROM_CHR_ROM:[3,2,2,2],RAM_RAM_IO_ROM:[0,0,1,2],CART_ROM_IO_ROM:[3,2,1,2],CART_NONE_IO_CART:[3,2,1,3],RAM_ROM_CHR_ROM:[0,2,2,2],RAM_ROM_IO_ROM:[0,2,1,2]},Wt=[y.RAM_RAM_RAM_RAM,y.RAM_RAM_RAM_RAM,y.RAM_CART_CHR_ROM,y.CART_CART_CHR_ROM,y.RAM_RAM_RAM_RAM,y.RAM_RAM_IO_RAM,y.RAM_CART_IO_ROM,y.CART_CART_IO_ROM,y.RAM_RAM_RAM_RAM,y.RAM_RAM_CHR_RAM,y.RAM_RAM_CHR_ROM,y.CART_ROM_CHR_ROM,y.RAM_RAM_RAM_RAM,y.RAM_RAM_IO_RAM,y.RAM_RAM_IO_ROM,y.CART_ROM_IO_ROM,y.CART_NONE_IO_CART,y.CART_NONE_IO_CART,y.CART_NONE_IO_CART,y.CART_NONE_IO_CART,y.CART_NONE_IO_CART,y.CART_NONE_IO_CART,y.CART_NONE_IO_CART,y.CART_NONE_IO_CART,y.RAM_RAM_RAM_RAM,y.RAM_RAM_CHR_RAM,y.RAM_RAM_CHR_ROM,y.RAM_ROM_CHR_ROM,y.RAM_RAM_RAM_RAM,y.RAM_RAM_IO_RAM,y.RAM_RAM_IO_ROM,y.RAM_ROM_IO_ROM];class Ge{constructor(e){a(this,"array");this.array=[...e]}read(e){return this.array[e]}readMany(e,r){const s=[];for(let i=e;i<r;i++)s.push(this.read(i));return s}write(e,r){this.array[e]=r}load(e,r,s=0){for(let i=0;i<e.length;i++)this.array[r+s+i]=e[i]}}class ke extends Ge{write(e,r){throw new Error("Read only!")}}class qt extends Ge{}class Jt extends Ge{read(e){return this.array[e-55296]}write(e,r){this.array[e-55296]=r}}class xt extends ke{read(e){return this.array[e-53248]}load(e,r){ke.prototype.load.bind(this)(e,r,-53248)}}class ut extends ke{read(e){return this.array[e-57344]}load(e,r){ke.prototype.load.bind(this)(e,r,-57344)}}class ft extends ke{read(e){return this.array[e-40960]}load(e,r){ke.prototype.load.bind(this)(e,r,-40960)}}class er{constructor(){a(this,"cartridge");a(this,"ram");a(this,"romCharset");a(this,"kernal");a(this,"io");a(this,"basicRom");a(this,"colorRam");a(this,"pinEXROM");a(this,"pinGAME");a(this,"activePlaSetup");this.cartridge=null,this.activePlaSetup=new ct(0,2,1,2),this.ram=new qt(new Array(65536)),this.pinEXROM=!1,this.pinGAME=!1,this.resetRAM(),this.colorRam=new Jt(new Array(1024)),this.colorRam.array.fill(0)}resetRAM(){for(let e=0;e<65536;e++)this.ram.array[e]=e&64?255:0}setPLA(e){const r=(this.pinEXROM?0:16)+(this.pinGAME?0:8)+(e&7),s=Wt[r];this.activePlaSetup.setMemMode(s[0],s[1],s[2],s[3])}setOptions(e){Object.keys(e).forEach(r=>{this[r]=e[r]})}readMany(e,r){const s=[];for(let i=e;i<r;i++)s.push(this.read(i));return s}vic_read(e){return e&=65535,e>=4096&&e<=8191?this.romCharset.array[e-4096]:e>=36864&&e<=40959?this.romCharset.array[e-36864]:this.ram.read(e)}read(e){var r;return this.readWithPLA(e,this.activePlaSetup,((r=this.cartridge)==null?void 0:r.activePage)||0)}getMemType(e){e&=65535;const r=this.activePlaSetup;return e>=32768&&e<=40959?r.mem_8000:e>=40960&&e<=49151?r.mem_a000:e>=53248&&e<=57343?r.mem_d000:e>=57344&&e<=65535?r.mem_e000:0}readWithoutSideeffects(e){return this.read(e)}readWithPLA(e,r,s){if(e&=65535,e>=32768&&e<=40959)switch(r.mem_8000){case 3:return this.cartridge.readWithPage(e,s);case 0:return this.ram.read(e);default:throw new Error("Invalid Memory Mode")}else if(e>=40960&&e<=49151)switch(r.mem_a000){case 3:return this.cartridge.readWithPage(e,s);case 0:return this.ram.read(e);case 2:return this.basicRom.read(e);default:throw new Error("Invalid Memory Mode")}else if(e>=53248&&e<=57343)switch(r.mem_d000){case 0:return this.ram.read(e);case 2:return this.romCharset.read(e);case 1:return this.io.read(e);default:throw new Error("Invalid Memory Mode")}else if(e>=57344&&e<=65535)switch(r.mem_e000){case 0:return this.ram.read(e);case 2:return this.kernal.read(e);default:throw new Error("Invalid Memory Mode")}return this.ram.read(e)}}class tr extends Ge{constructor(r){super([]);a(this,"ioOwner");this.ioOwner=r}read(r){return this.ioOwner.read(r)}write(r,s){this.ioOwner.write(r,s)}}class rr{constructor(){a(this,"memoryManager");a(this,"vic");a(this,"cia1");a(this,"cpu");a(this,"keyboard");a(this,"joystick");a(this,"clock");a(this,"lastRead");a(this,"lastWrite");a(this,"lastRW");a(this,"io");a(this,"readAddressList");a(this,"writeAddressList");a(this,"dd00");a(this,"cpu00",0);a(this,"cpu01",0);this.memoryManager=new er,this.readAddressList=new Array(65536).fill(-1e6),this.writeAddressList=new Array(65536).fill(-1e6),this.io=!0,this.dd00=0,this.lastRW=0,this.lastRead=0,this.lastWrite=0}addCPU(e){this.cpu=e}addClock(e){this.clock=e}addVIC(e){this.vic=e,this.vic.bus=this}addCIA1(e){this.cia1=e}addKeyboard(e){this.keyboard=e}addJoystick(e){this.joystick=e}addCartridge(){}write(e,r,s=this.io){if(r>255&&console.log(`Invalid data: ${r}`),e<=1)switch(e){case 0:this.cpu00=r;break;case 1:this.cpu01=r,this.memoryManager.setPLA(r);break}if(this.lastWrite=e,this.lastRW=e,this.writeAddressList[e]=this.clock.totalCycles,s&&e>=53248&&e<=57343){if(e>=53248&&e<=54271)return this.vic.write(e&61695,r);if(!(e>=54272&&e<=55295)){if(e>=55296&&e<=56319)return this.memoryManager.colorRam.write(e,r);if(e>=56320&&e<=56575)return this.cia1.write(e&65295,r);if(e>=56576&&e<=56831&&!(e&15))return this.dd00=r,this.vic.setVicBank(3-(r&3))}}const i=this.memoryManager.ram.array[e];if(this.memoryManager.ram.write(e,r),e==45||e==46){if(e==45&&r==i||e==46&&r==i)return;const n=this.memoryManager.ram.array[43]+this.memoryManager.ram.array[44]*256,o=this.memoryManager.ram.array[45]+this.memoryManager.ram.array[46]*256;if(n==0||o<=n)return;this.dispatchReadBasicFromRamEvent(1e3)}}dispatchReadBasicFromRamEvent(e){const r=this.memoryManager.ram.array[43]+this.memoryManager.ram.array[44]*256,s=this.memoryManager.ram.array[45]+this.memoryManager.ram.array[46]*256;r==0||s<=r||setTimeout(()=>{this.memoryManager.ram.array.slice(r,s)},e)}readWithoutSideffects(e){return this.read(e)}getMemType(e){return this.memoryManager.getMemType(e)}read(e){if(this.lastRead=e,this.lastRW=e,this.readAddressList[e]=this.clock.totalCycles,this.io&&e>=53248&&e<=57343){if(e>=53248&&e<=54271)return this.vic.read(e&61695);if(!(e>=54272&&e<=55295)){if(e>=55296&&e<=56319)return this.memoryManager.colorRam.read(e);if(e>=56320&&e<=56575)return this.cia1.read(e&65295);if(e>=56576&&e<=56831&&!(e&15))return this.dd00}}return this.memoryManager.read(e)}}var f=(t=>(t[t.N=128]="N",t[t.V=64]="V",t[t.B=16]="B",t[t.D=8]="D",t[t.I=4]="I",t[t.Z=2]="Z",t[t.C=1]="C",t))(f||{});class sr{constructor(e){a(this,"bus");a(this,"pc",0);a(this,"sp",0);a(this,"a",0);a(this,"x",0);a(this,"y",0);a(this,"flags",0);a(this,"adr",0);a(this,"currOpMode");a(this,"currOpFunc");a(this,"opcode",0);a(this,"cacheInstructions",!1);a(this,"target","");a(this,"instructions");a(this,"clockCount",0);a(this,"irqNeeded",!1);a(this,"irqFinished",!1);a(this,"instrCache");a(this,"isKilled",!1);a(this,"error","");a(this,"saveDefaultFields",[]);a(this,"dataLo",0);a(this,"dataHi",0);a(this,"memType");a(this,"execAddresses");this.instructions=e,this.reset(),this.instrCache=[],this.saveDefaultFields="a x y sp pc flags clockCount adr dataLo dataHi memType".split(" "),this.execAddresses={0:{},1:{},2:{},3:{}}}before(e){}logInstr(e){const r={};this.saveDefaultFields.forEach(s=>{r[s]=this[s]}),Object.assign(r,e),this.instrCache.push(r),this.instrCache.length>1e4&&(this.instrCache=this.instrCache.slice(-5e3))}logInstrUpdate(e){const r=this.instrCache.length-1;r>=0&&Object.assign(this.instrCache[r],e)}formatLog(){try{let e="";for(let r=0;r<this.instrCache.length;r++)e+=this.formatLogItem(this.instrCache[r]);return e}catch{return console.log("Log error!"),""}}formatLogItem(e){return JSON.stringify(e)+`
`}reportTermination(){throw Error("Terminated!")}halt(){return this.error="no rom found.",1e6}clock(){this.irqNeeded&&(this.irq(),this.irqNeeded=!1);const e=this.pc;this.memType=this.bus.getMemType(this.pc),this.execAddresses[this.memType][e]=this.clockCount;const r=this.readPC();if(r===void 0)return this.halt();this.opcode=r,this.dataLo=this.bus.readWithoutSideffects(this.pc),this.dataHi=this.bus.readWithoutSideffects(this.pc+1);const[s,i,n,o,l,c]=this.instructions[r];this.cacheInstructions&&this.logInstr({pc:e,opName:s,modeStr:c,opcode:r}),this.clockCount++,this.before(r),this.currOpMode=n,this.currOpFunc=i;const d=n(this),h=i(this);this.after();let u=o+d+h;return isNaN(u)&&(u=0,this.isKilled=!0),this.cacheInstructions&&this.logInstrUpdate({afterAdr:this.adr,afterKilled:this.isKilled,cyclesUsed:u}),this.isKilled&&this.reportTermination(),u}after(){}sysCall(e){}addBus(e){this.bus=e}read(e){return this.bus.read(e)}readPC(){const e=this.bus.read(this.pc);if(this.pc=this.pc+1&65535,Number.isNaN(e))throw Error("Invalid number!");return e}write(e,r){this.bus.write(e,r)}irq(){}nmi(){}reset(){this.pc=0,this.isKilled=!1,this.error="",this.a=0,this.x=0,this.y=0,this.sp=253,this.flags=32,this.adr=0,this.clockCount=0,this.irqNeeded=!1,this.irqFinished=!1}setFlag(e,r){this.flags&=~e,r&&(this.flags|=e)}getFlag(e){return(this.flags&e)>0?1:0}setFlagZ(e){this.flags&=-3,e==0&&(this.flags|=2)}setFlagN(e){this.flags&=-129,e&128&&(this.flags|=128)}setFlagNZ(e){this.setFlagN(e),this.setFlagZ(e)}setPc(e){this.pc=e}}function It(t,e){return t.toString(16).padStart(e,"0")}function q(t){return It(t,2)}function Ze(t){return It(t,4)}function ir(t,e){return t.toString(2).padStart(e,"0")}function nr(t){return ir(t,8)}function Je(t){return t%10+(Math.floor(t/10)&15)*16}class yt{constructor(){a(this,"latchValue",0);a(this,"counter",0);a(this,"flags",0);a(this,"change");a(this,"stopAfterUnderflow",!0);this.change=!1}}class ar{constructor(e){a(this,"timerA");a(this,"timerB");a(this,"realTimeClock",0);a(this,"freq",0);this.bus=e,this.timerA=new yt,this.timerB=new yt,this.reset(),this.setFreq(1e6)}addCycles(e){this.realTimeClock+=e,this.timerA.counter!==void 0&&this.timerA.change&&(this.timerA.counter-=e),this.timerA.counter<0&&(this.timerA.stopAfterUnderflow?(this.timerA.change=!1,this.bus.cpu.getFlag(f.I)==0&&this.bus.cpu.irq()):this.bus.cpu.getFlag(f.I)==0&&(this.bus.cpu.irq(),this.timerA.counter=this.timerA.latchValue,this.timerA.change=!0)),this.timerB.counter&&this.timerB.change&&(this.timerB.counter-=e),this.timerB.counter<0}setFreq(e){this.freq=e}reset(){this.realTimeClock=0}read(e){switch(e&15){case 0:return this.bus.joystick.read(0);case 1:return this.bus.keyboard.read(e)&this.bus.joystick.read(1);case 2:case 3:return this.bus.keyboard.read(e);case 4:return this.timerA.counter&255;case 5:return this.timerA.counter>>8&255;case 6:return this.timerB.counter&255;case 7:return this.timerB.counter>>8&255;case 8:return Math.round(this.realTimeClock/this.freq*10)%10;case 9:return Je(Math.round(this.realTimeClock/this.freq)%60);case 10:return Je(Math.round(this.realTimeClock/this.freq*60)%60);case 11:{const r=Je(Math.round(this.realTimeClock/this.freq*60*60)%12);return r+(r>=12?128:0)}case 13:{let r=this.timerA.counter<0?1:0;return r|=this.timerB.counter<0?2:0,r}default:return 0}}write(e,r){switch(e&15){case 0:case 1:case 2:case 3:this.bus.keyboard.write(e,r);break;case 4:this.timerA.counter&=65280,this.timerA.counter+=r,this.timerA.latchValue=this.timerA.counter;break;case 5:this.timerA.counter&=255,this.timerA.counter+=r<<8,this.timerA.latchValue=this.timerA.counter;break;case 6:this.timerB.counter&=65280,this.timerB.counter+=r,this.timerB.latchValue=this.timerB.counter;break;case 7:this.timerB.counter&=255,this.timerB.counter+=r<<8,this.timerB.latchValue=this.timerB.counter;break;case 8:return;case 9:return;case 10:return;case 11:return;case 13:return;case 14:this.timerA.flags=r,this.timerA.change=(r&1)>0,this.timerA.stopAfterUnderflow=(r&8)>0,(r&16)>0&&(this.timerA.counter=this.timerA.latchValue);break}}}class or{constructor(){a(this,"totalCycles");a(this,"bus");a(this,"fpsCount");a(this,"pcCallbacks");this.totalCycles=0,this.fpsCount=0,this.pcCallbacks=Array(65536).fill(null)}addBus(e){this.bus=e}renderNext(){let e=!1,r=1;this.bus.vic.requestIRQ&&(this.bus.cpu.irqNeeded=!0,this.bus.vic.requestIRQ=!1),e||(r=this.clockAll()),e=this.bus.vic.render(r),this.totalCycles+=r}renderVIC(){let e=0;for(;e<this.bus.vic.scanLines;){const r=this.bus.vic.rasterY;this.bus.vic.render(8),r!=this.bus.vic.rasterY&&e++}}clockAll(){const e=this.pcCallbacks[this.bus.cpu.pc];e&&e.forEach(s=>{s()});const r=this.bus.cpu.clock();return this.bus.cia1.addCycles(r),r}renderFrame(e=4){if(!this.bus.cpu.error)for(let r=0;r<e;r++){for(;!this.bus.vic.isRendered();)this.renderNext();this.bus.vic.reset(),this.fpsCount++}}debugOnce(e){let r=!1;this.bus.vic.rasterY==0&&!this.bus.cpu.irqFinished&&(this.bus.cpu.irqNeeded=!0),this.bus.vic.rasterY>255&&(this.bus.cpu.irqFinished=!1);let s=1;r||(s=this.clockAll()),r=this.bus.vic.render(s),this.totalCycles+=s}debugNextFew(e){for(let r=0;r<e;r++)this.debugOnce([]);this.bus.vic.isRendered()}debugUntilBreakpoint(e,r=1){for(let s=0;s<r;s++)e&&e.indexOf(this.bus.cpu.pc)==-1&&this.debugOnce([]);this.bus.vic.isRendered()&&this.fpsCount++}}class cr extends sr{constructor(){super(dr)}irq(){vr(this),this.irqNeeded=!1}nmi(){Mr(this)}formatLogItem(e){const[r,s]=lr[e.modeStr],i=e.dataLo,n=e.dataHi,o=e.pc+(i&127)-(i&128)&65535,l=r>1?q(e.dataLo):"  ",c=r>2?q(e.dataHi):"  ",d=e.opName+" "+s.replace("@H",q(n)).replace("@L",q(i)).replace("@R",Ze(o)),h=`Clock     NV-BDIZC SP   A  X  Y   PC     Instruction 
`,u=`${q(e.opcode)} ${l} ${c}  `,x=`${e.clockCount}    ${nr(e.flags)} ${q(e.sp)} ${q(e.a)} ${q(e.x)} ${q(e.y)}   $${Ze(e.pc)}: ${u} ${d.padEnd(14," ")}`+(e.adr!=e.afterAdr?`(->$${Ze(e.afterAdr)})`:"")+`
`;return(e.extra?e.extra+`
`:"")+(e.clockCount%16==0?h:"")+x}reportTermination(e=!0){try{const r=this.formatLog(),s=new Blob([r],{type:"text/plain;charset=utf-8"}),i=document.createElement("a");i.href=URL.createObjectURL(s),i.download="logs.txt",i.click(),URL.revokeObjectURL(i.href)}catch{console.error("Termination report failed.")}if(e)throw Error("Terminated")}sysCall(e){const r=this.flags,s=this.sp,i=this.pc;for(this.pc=e,this.currOpFunc=hr;s>this.sp||this.currOpFunc.name!="RTS";)this.clock();this.pc=i,this.sp=s,this.flags=r}}const lr={imp:[1,""],imm:[2,"#$@L"],rel:[2,"@R"],abs:[3,"$@H@L"],abx:[3,"$@H@L, x"],aby:[3,"$@H@L, y"],zp:[2,"$@L"],zpx:[2,"$@L, x"],zpy:[2,"$@L, y"],izx:[2,"($@L, x)"],izy:[2,"($@L), y"],ind:[3,"($@H@L)"]},dr=[["BRK",Nr,_,7,0,"imp"],["ORA",re,P,6,0,"izx"],["KIL",U,_,0,-10,"imp"],["SLO",xe,P,8,-10,"izx"],["NOP",k,T,3,-10,"zp"],["ORA",re,T,3,0,"zp"],["ASL",He,T,5,0,"zp"],["SLO",xe,T,5,-10,"zp"],["PHP",kr,_,3,0,"imp"],["ORA",re,v,2,0,"imm"],["ASL",Dr,_,2,0,"imp"],["ANC",Ct,v,2,-10,"imm"],["NOP",k,S,4,-10,"abs"],["ORA",re,S,4,0,"abs"],["ASL",He,S,6,1,"abs"],["SLO",xe,S,6,-10,"abs"],["BPL",Zr,te,2,2,"rel"],["ORA",re,I,5,0,"izy"],["KIL",U,_,0,-10,"imp"],["SLO",xe,I,8,-10,"izy"],["NOP",k,R,4,-10,"zpx"],["ORA",re,R,4,0,"zpx"],["ASL",He,R,6,0,"zpx"],["SLO",xe,R,6,-10,"zpx"],["CLC",Fr,_,2,2,"imp"],["ORA",re,E,4,0,"aby"],["NOP",k,_,2,-10,"imp"],["SLO",xe,E,7,-10,"aby"],["NOP",k,C,4,-10,"abx"],["ORA",re,C,4,0,"abx"],["ASL",He,C,7,0,"abx"],["SLO",xe,C,7,-10,"abx"],["JSR",Ar,S,6,20,"abs"],["AND",se,P,6,0,"izx"],["KIL",U,_,0,-10,"imp"],["RLA",le,P,8,-10,"izx"],["BIT",Tt,T,3,0,"zp"],["AND",se,T,3,0,"zp"],["ROL",Ke,T,5,0,"zp"],["RLA",le,T,5,-10,"zp"],["PLP",wr,_,4,0,"imp"],["AND",se,v,2,0,"imm"],["ROL",Ir,_,2,0,"imp"],["ANC",Ct,v,2,-10,"imm"],["BIT",Tt,S,4,0,"abs"],["AND",se,S,4,0,"abs"],["ROL",Ke,S,6,0,"abs"],["RLA",le,S,6,-10,"abs"],["BMI",jr,te,2,1,"rel"],["AND",se,I,5,0,"izy"],["KIL",U,_,0,-10,"imp"],["RLA",le,I,8,-10,"izy"],["NOP",k,R,4,-10,"zpx"],["AND",se,R,4,0,"zpx"],["ROL",Ke,R,6,0,"zpx"],["RLA",le,R,6,-10,"zpx"],["SEC",Br,_,2,1,"imp"],["AND",se,E,4,0,"aby"],["NOP",k,_,2,-10,"imp"],["RLA",le,E,7,-10,"aby"],["NOP",k,C,4,-10,"abx"],["AND",se,C,4,0,"abx"],["ROL",Ke,C,7,0,"abx"],["RLA",le,C,7,-10,"abx"],["RTI",Er,_,6,0,"imp"],["EOR",ie,P,6,0,"izx"],["KIL",U,_,0,-10,"imp"],["SRE",fe,P,8,-10,"izx"],["NOP",k,T,3,-10,"zp"],["EOR",ie,T,3,0,"zp"],["LSR",$e,T,5,0,"zp"],["SRE",fe,T,5,-10,"zp"],["PHA",Cr,_,3,3,"imp"],["EOR",ie,v,2,1,"imm"],["LSR",Lr,_,2,0,"imp"],["ALR",rs,v,2,-10,"imm"],["JMP",St,S,3,6,"abs"],["EOR",ie,S,4,0,"abs"],["LSR",$e,S,6,0,"abs"],["SRE",fe,S,6,-10,"abs"],["BVC",Gr,te,2,0,"rel"],["EOR",ie,I,5,0,"izy"],["KIL",U,_,0,-10,"imp"],["SRE",fe,I,8,-10,"izy"],["NOP",k,R,4,-10,"zpx"],["EOR",ie,R,4,0,"zpx"],["LSR",$e,R,6,0,"zpx"],["SRE",fe,R,6,-10,"zpx"],["CLI",Hr,_,2,0,"imp"],["EOR",ie,E,4,0,"aby"],["NOP",k,_,2,-10,"imp"],["SRE",fe,E,7,-10,"aby"],["NOP",k,C,4,-10,"abx"],["EOR",ie,C,4,0,"abx"],["LSR",$e,C,7,0,"abx"],["SRE",fe,C,7,-10,"abx"],["RTS",Or,_,6,3,"imp"],["ADC",J,P,6,0,"izx"],["KIL",U,_,0,-10,"imp"],["RRA",he,P,8,-10,"izx"],["NOP",k,T,3,-10,"zp"],["ADC",J,T,3,0,"zp"],["ROR",Ue,T,5,0,"zp"],["RRA",he,T,5,-10,"zp"],["PLA",Rr,_,4,4,"imp"],["ADC",J,v,2,1,"imm"],["ROR",Pr,_,2,0,"imp"],["ARR",Jr,v,2,-10,"imm"],["JMP",St,xr,5,0,"ind"],["ADC",J,S,4,2,"abs"],["ROR",Ue,S,6,0,"abs"],["RRA",he,S,6,-10,"abs"],["BVS",Wr,te,2,0,"rel"],["ADC",J,I,5,0,"izy"],["KIL",U,_,0,-10,"imp"],["RRA",he,I,8,-10,"izy"],["NOP",k,R,4,-10,"zpx"],["ADC",J,R,4,0,"zpx"],["ROR",Ue,R,6,0,"zpx"],["RRA",he,R,6,-10,"zpx"],["SEI",Ur,_,2,0,"imp"],["ADC",J,E,4,0,"aby"],["NOP",k,_,2,-10,"imp"],["RRA",he,E,7,-10,"aby"],["NOP",k,C,4,-10,"abx"],["ADC",J,C,4,0,"abx"],["ROR",Ue,C,7,0,"abx"],["RRA",he,C,7,-10,"abx"],["NOP",k,v,2,-10,"imm"],["STA",ce,P,6,0,"izx"],["NOP",k,v,2,-10,"imm"],["SAX",Xe,P,6,-10,"izx"],["STY",tt,T,3,0,"zp"],["STA",ce,T,3,0,"zp"],["STX",et,T,3,0,"zp"],["SAX",Xe,T,3,-10,"zp"],["DEY",ur,_,2,1,"imp"],["NOP",k,v,2,-10,"imm"],["TXA",mr,_,2,1,"imp"],["XAA",es,v,2,-10,"imm"],["STY",tt,S,4,5,"abs"],["STA",ce,S,4,14,"abs"],["STX",et,S,4,3,"abs"],["SAX",Xe,S,4,-10,"abs"],["BCC",Yr,te,2,4,"rel"],["STA",ce,I,6,2,"izy"],["KIL",U,_,0,-10,"imp"],["AHX",Rt,I,6,-10,"izy"],["STY",tt,R,4,0,"zpx"],["STA",ce,R,4,0,"zpx"],["STX",et,Be,4,0,"zpy"],["SAX",Xe,Be,4,-10,"zpy"],["TYA",gr,_,2,1,"imp"],["STA",ce,E,5,0,"aby"],["TXS",Tr,_,2,0,"imp"],["TAS",is,E,5,-10,"aby"],["SHY",qr,C,5,-10,"abx"],["STA",ce,C,5,0,"abx"],["SHX",ts,E,5,-10,"aby"],["AHX",Rt,E,5,-10,"aby"],["LDY",Me,v,2,6,"imm"],["LDA",ne,P,6,0,"izx"],["LDX",ve,v,2,3,"imm"],["LAX",ue,P,6,-10,"izx"],["LDY",Me,T,3,0,"zp"],["LDA",ne,T,3,0,"zp"],["LDX",ve,T,3,0,"zp"],["LAX",ue,T,3,-10,"zp"],["TAY",yr,_,2,1,"imp"],["LDA",ne,v,2,7,"imm"],["TAX",br,_,2,2,"imp"],["LAX",ue,v,2,-10,"imm"],["LDY",Me,S,4,3,"abs"],["LDA",ne,S,4,12,"abs"],["LDX",ve,S,4,2,"abs"],["LAX",ue,S,4,-10,"abs"],["BCS",Qr,te,2,2,"rel"],["LDA",ne,I,5,4,"izy"],["KIL",U,_,0,-10,"imp"],["LAX",ue,I,5,-10,"izy"],["LDY",Me,R,4,0,"zpx"],["LDA",ne,R,4,0,"zpx"],["LDX",ve,Be,4,0,"zpy"],["LAX",ue,Be,4,-10,"zpy"],["CLV",Vr,_,2,0,"imp"],["LDA",ne,E,4,0,"aby"],["TSX",Sr,_,2,0,"imp"],["LAS",ss,E,4,-10,"aby"],["LDY",Me,C,4,0,"abx"],["LDA",ne,C,4,0,"abx"],["LDX",ve,E,4,0,"aby"],["LAX",ue,E,4,-10,"aby"],["CPY",st,v,2,0,"imm"],["CMP",ae,P,6,0,"izx"],["NOP",k,v,2,-10,"imm"],["DCP",_e,P,8,-10,"izx"],["CPY",st,T,3,0,"zp"],["CMP",ae,T,3,0,"zp"],["DEC",ze,T,5,0,"zp"],["DCP",_e,T,5,-10,"zp"],["INY",pr,_,2,4,"imp"],["CMP",ae,v,2,3,"imm"],["DEX",fr,_,2,0,"imp"],["AXS",ns,v,2,-10,"imm"],["CPY",st,S,4,0,"abs"],["CMP",ae,S,4,1,"abs"],["DEC",ze,S,6,0,"abs"],["DCP",_e,S,6,-10,"abs"],["BNE",Kr,te,2,8,"rel"],["CMP",ae,I,5,0,"izy"],["KIL",U,_,0,-10,"imp"],["DCP",_e,I,8,-10,"izy"],["NOP",k,R,4,-10,"zpx"],["CMP",ae,R,4,0,"zpx"],["DEC",ze,R,6,0,"zpx"],["DCP",_e,R,6,-10,"zpx"],["CLD",zr,_,2,0,"imp"],["CMP",ae,E,4,0,"aby"],["NOP",k,_,2,-10,"imp"],["DCP",_e,E,7,-10,"aby"],["NOP",k,C,4,-10,"abx"],["CMP",ae,C,4,0,"abx"],["DEC",ze,C,7,0,"abx"],["DCP",_e,C,7,-10,"abx"],["CPX",rt,v,2,0,"imm"],["SBC",Q,P,6,0,"izx"],["NOP",k,v,2,-10,"imm"],["ISC",de,P,8,-10,"izx"],["CPX",rt,T,3,0,"zp"],["SBC",Q,T,3,0,"zp"],["INC",Ve,T,5,0,"zp"],["ISC",de,T,5,-10,"zp"],["INX",_r,_,2,1,"imp"],["SBC",Q,v,2,1,"imm"],["NOP",k,_,2,0,"imp"],["SBC",Q,v,2,-10,"imm"],["CPX",rt,S,4,0,"abs"],["SBC",Q,S,4,1,"abs"],["INC",Ve,S,6,1,"abs"],["ISC",de,S,6,-10,"abs"],["BEQ",Xr,te,2,6,"rel"],["SBC",Q,I,5,0,"izy"],["KIL",U,_,0,-10,"imp"],["ISC",de,I,8,-10,"izy"],["NOP",k,R,4,-10,"zpx"],["SBC",Q,R,4,0,"zpx"],["INC",Ve,R,6,0,"zpx"],["ISC",de,R,6,-10,"zpx"],["SED",$r,_,2,0,"imp"],["SBC",Q,E,4,0,"aby"],["NOP",k,_,2,-10,"imp"],["ISC",de,E,7,-10,"aby"],["NOP",k,C,4,-10,"abx"],["SBC",Q,C,4,0,"abx"],["INC",Ve,C,7,0,"abx"],["ISC",de,C,7,-10,"abx"]];function v(t){return t.adr=t.pc++,t.pc&=65535,0}function hr(t){}function xr(t){let e=t.readPC()+(t.readPC()<<8);return(e&255)==255?t.adr=t.read(e)+t.read(++e-256)*256:t.adr=t.read(e)+t.read(++e)*256,0}function P(t){let e=t.readPC()+t.x&255;return t.adr=t.read(e)+(t.read(++e&255)<<8),0}function I(t){let e=t.readPC();const r=t.read(e)+(t.read(++e&255)<<8);return t.adr=r+t.y&65535,(r^t.adr)>255?1:0}function S(t){return t.adr=t.readPC()+(t.readPC()<<8),0}function E(t){const e=t.readPC()+(t.readPC()<<8);return t.adr=e+t.y&65535,(e^t.adr)>255?1:0}function C(t){const e=t.readPC()+(t.readPC()<<8);return t.adr=e+t.x&65535,(e^t.adr)>255?1:0}function te(t){const e=t.readPC();return t.adr=t.pc+(e&127)-(e&128)&65535,0}function _(t){return 0}function T(t){return t.adr=t.readPC(),0}function R(t){return t.adr=t.readPC()+t.x&255,0}function Be(t){return t.adr=t.readPC()+t.y&255,0}function ur(t){return t.y=--t.y&255,t.setFlagNZ(t.y),0}function fr(t){return t.x=--t.x&255,t.setFlagNZ(t.x),0}function _r(t){return t.x=++t.x&255,t.setFlagNZ(t.x),0}function pr(t){return t.y=++t.y&255,t.setFlagNZ(t.y),0}function re(t){return t.a=t.a|t.read(t.adr),t.setFlagNZ(t.a),0}function se(t){return t.a=t.a&t.read(t.adr),t.setFlagNZ(t.a),0}function ie(t){return t.a=t.a^t.read(t.adr),t.setFlagNZ(t.a),0}function mr(t){return t.a=t.x,t.setFlagNZ(t.a),0}function gr(t){return t.a=t.y,t.setFlagNZ(t.a),0}function br(t){return t.x=t.a,t.setFlagNZ(t.x),0}function yr(t){return t.y=t.a,t.setFlagNZ(t.y),0}function Sr(t){return t.x=t.sp,t.setFlagNZ(t.x),0}function Tr(t){return t.sp=t.x,t.setFlagNZ(t.sp),0}function ne(t){return t.a=t.read(t.adr),t.setFlagNZ(t.a),0}function ve(t){return t.x=t.read(t.adr),t.setFlagNZ(t.x),0}function Me(t){return t.y=t.read(t.adr),t.setFlagNZ(t.y),0}function ce(t){return t.write(t.adr,t.a),0}function et(t){return t.write(t.adr,t.x),0}function tt(t){return t.write(t.adr,t.y),0}function Cr(t){return t.write(256+(t.sp--&255),t.a),t.sp&=255,0}function Rr(t){return t.a=t.read(256+(++t.sp&255)),t.sp&=255,t.setFlagNZ(t.a),0}function kr(t){return t.write(256+(t.sp--&255),t.flags),t.sp&=255,0}function wr(t){return t.flags=t.read(256+(++t.sp&255)),t.sp&=255,0}function Ve(t){const e=t.read(t.adr);t.write(t.adr,e);const r=e+1&255;return t.setFlagNZ(r),t.write(t.adr,r),0}function ze(t){const e=t.read(t.adr);t.write(t.adr,e);const r=e-1&255;return t.setFlagNZ(r),t.write(t.adr,r),0}function St(t){return t.pc=t.adr,0}function Ar(t){return t.write(256+(t.sp--&255),t.pc-1>>8),t.sp&=255,t.write(256+(t.sp--&255),t.pc-1&255),t.sp&=255,t.pc=t.adr,0}function _t(t,e){return t.logInstrUpdate({extra:`Interrupt at ${Ze(e)}`}),t.write(256+(t.sp--&255),t.pc-1>>8),t.sp&=255,t.write(256+(t.sp--&255),t.pc-1&255),t.sp&=255,t.write(256+(t.sp--&255),t.flags&239),t.sp&=255,t.adr=t.bus.read(e)+(t.bus.read(e+1)<<8),t.pc=t.adr,0}function vr(t){t.getFlag(f.I)||_t(t,65534)}function Mr(t){_t(t,65530)}function Or(t){return t.pc=t.read(256+(++t.sp&255))+t.read(256+(++t.sp&255))*256+1,0}function Er(t){return t.flags=t.read(256+(++t.sp&255)),t.pc=t.read(256+(++t.sp&255))+t.read(256+(++t.sp&255))*256+1,0}function Nr(t){return t.setFlag(f.I,!0),t.setFlag(f.B,!0),_t(t,65534),0}function ae(t){const e=t.a-t.read(t.adr);return t.setFlagNZ(e&255),t.setFlag(f.C,e>=0),0}function rt(t){const e=t.x-t.read(t.adr);return t.setFlagNZ(e&255),t.setFlag(f.C,e>=0),0}function st(t){const e=t.y-t.read(t.adr);return t.setFlagNZ(e&255),t.setFlag(f.C,e>=0),0}function J(t){let e=t.read(t.adr),r;if(t.currOpFunc==Q&&(e^=255),t.getFlag(f.D)){r=(t.a&15)+(e&15)+t.getFlag(f.C);const s=(t.a^r)&(e^r)&128;t.setFlag(f.V,s>0),r>=10&&(r=(r+6&15)+16),r+=(t.a&240)+(e&240),r>=160&&(r+=96),t.setFlag(f.C,r>255),t.a=t.a&255,t.setFlagNZ(t.a)}else{r=t.a+e+t.getFlag(f.C);const s=(t.a^r)&(e^r)&128;t.setFlag(f.V,s>0),t.a=r&255,t.setFlagNZ(t.a),t.setFlag(f.C,r>255)}return 0}function Q(t){return J(t)}function $e(t){const e=t.read(t.adr);t.write(t.adr,e);const r=e>>1&255;return t.write(t.adr,r),t.setFlag(f.C,(e&1)==1),t.setFlagNZ(r),0}function He(t){const e=t.read(t.adr);t.write(t.adr,e);const r=e<<1&255;return t.write(t.adr,r),t.setFlag(f.C,(e&128)==128),t.setFlagNZ(r),0}function Ue(t){const e=t.read(t.adr);t.write(t.adr,e);const r=(e>>1)+t.getFlag(f.C)*128&255;return t.write(t.adr,r),t.setFlag(f.C,(e&1)==1),t.setFlagNZ(r),0}function Ke(t){const e=t.read(t.adr);t.write(t.adr,e);const r=(e<<1)+t.getFlag(f.C)&255;return t.write(t.adr,r),t.setFlag(f.C,(e&128)==128),t.setFlagNZ(r),0}function Lr(t){return t.setFlag(f.C,(t.a&1)==1),t.a=t.a>>1,t.setFlagNZ(t.a),0}function Dr(t){return t.setFlag(f.C,(t.a&128)==128),t.a=t.a<<1&255,t.setFlagNZ(t.a),0}function Pr(t){const e=(t.a>>1)+t.getFlag(f.C)*128&255;return t.setFlag(f.C,(t.a&1)==1),t.a=e,t.setFlagNZ(t.a),0}function Ir(t){const e=(t.a<<1)+t.getFlag(f.C)&255;return t.setFlag(f.C,(t.a&128)==128),t.a=e,t.setFlagNZ(t.a),0}function Tt(t){const e=t.read(t.adr);return t.setFlag(f.N,(e&128)==128),t.setFlag(f.V,(e&64)==64),t.setFlag(f.Z,(e&t.a)==0),0}function k(t){return 0}function Fr(t){return t.setFlag(f.C,!1),0}function Br(t){return t.setFlag(f.C,!0),0}function Vr(t){return t.setFlag(f.V,!1),0}function zr(t){return t.setFlag(f.D,!1),0}function $r(t){return t.setFlag(f.D,!0),0}function Hr(t){return t.setFlag(f.I,!1),0}function Ur(t){return t.setFlag(f.I,!0),0}function Kr(t){return t.getFlag(f.Z)?0:(t.pc=t.adr,1)}function Xr(t){return t.getFlag(f.Z)?(t.pc=t.adr,1):0}function Yr(t){return t.getFlag(f.C)?0:(t.pc=t.adr,1)}function Qr(t){return t.getFlag(f.C)?(t.pc=t.adr,1):0}function Zr(t){return t.getFlag(f.N)?0:(t.pc=t.adr,1)}function jr(t){return t.getFlag(f.N)?(t.pc=t.adr,1):0}function Gr(t){return t.getFlag(f.V)?0:(t.pc=t.adr,1)}function Wr(t){return t.getFlag(f.V)?(t.pc=t.adr,1):0}function U(t){return t.isKilled=!0,0}function le(t){const e=t.read(t.adr);t.write(t.adr,e);const r=(e<<1)+t.getFlag(f.C)&255;return t.write(t.adr,r),t.setFlag(f.C,(e&128)==128),t.setFlagNZ(r),t.a=t.a&t.read(t.adr),t.setFlagNZ(t.a),0}function de(t){return t.isKilled=!0,0}function he(t){return t.isKilled=!0,0}function Xe(t){return t.isKilled=!0,0}function xe(t){const e=t.read(t.adr);t.write(t.adr,e),t.setFlag(f.C,(e&128)==128);const r=e<<1&255;return t.setFlagNZ(r),t.write(t.adr,r),t.a=t.a|t.read(t.adr),t.setFlagNZ(t.a),0}function Ct(t){return t.isKilled=!0,0}function qr(t){return t.isKilled=!0,0}function Jr(t){return t.isKilled=!0,0}function es(t){return t.isKilled=!0,0}function ts(t){return t.isKilled=!0,0}function ue(t){return t.a=t.read(t.adr),t.x=t.a,t.setFlagNZ(t.a),0}function rs(t){return t.isKilled=!0,0}function Rt(t){return t.isKilled=!0,0}function ss(t){return t.isKilled=!0,0}function is(t){return t.isKilled=!0,0}function fe(t){const e=t.read(t.adr);t.write(t.adr,e);const r=e>>1&255;return t.write(t.adr,r),t.setFlag(f.C,(e&1)==1),t.setFlagNZ(r),t.a=t.a^t.read(t.adr),t.setFlagNZ(t.a),0}function ns(t){return t.isKilled=!0,0}function _e(t){return t.isKilled=!0,0}const ye=[128,64,32,16,8,4,2,1];class pe{constructor(e){a(this,"id");a(this,"x");a(this,"x1",0);a(this,"y");a(this,"y1",0);a(this,"doubleWidth");a(this,"doubleHeight");a(this,"colorCode");a(this,"multiColor");a(this,"visible");a(this,"displayable");a(this,"behindText");a(this,"vic");a(this,"data");a(this,"dataStart");a(this,"shape");this.x=0,this.y=0,this.doubleHeight=!1,this.doubleWidth=!1,this.multiColor=!1,this.visible=!1,this.displayable=this.isVisible(),this.behindText=!1,this.colorCode=0,this.id=e,this.shape=0,this.dataStart=0,this.data=new Array(64).fill(0)}isVisible(){return this.visible}getSpriteHeight(){return 21*(this.doubleHeight?2:1)}getSpriteWidth(){return 24*(this.doubleWidth?2:1)}setPos(e){"x"in e&&(this.x=e.x),"y"in e&&(this.y=e.y),this.x1=this.x+this.getSpriteWidth(),this.y1=this.y+this.getSpriteHeight()}bitIterator(e,r,s){for(let i=0;i<8;i++)s(e[i],r&1),r=r>>1}}class kt{constructor(){a(this,"bus");a(this,"renderer");a(this,"memory");a(this,"cycleCount",0);a(this,"ctx");a(this,"onscreenWidth",0);a(this,"onscreenHeight",0);a(this,"onscreenPixels",0);a(this,"screenBuffer");a(this,"imageData");a(this,"currentPixel",0);a(this,"rasterX",0);a(this,"rasterY",0);a(this,"frames",0);a(this,"cyclesPerLine",0);a(this,"pixelsMulti",8)}isRendered(){return!0}showGrids(){}initRowBlocks(){}render(e){this.initRowBlocks();for(let r=0,s=0;r<e;r++,s++)s>this.cyclesPerLine*this.pixelsMulti&&(this.initRowBlocks(),s=0),this.renderer();return this.cycleCount+=e,!1}getImageData(){return this.imageData}setRenderer(e){this.renderer=e}setMemory(e){this.memory=e}getDimensions(){return[this.onscreenWidth,this.onscreenHeight]}reset(){this.cycleCount=0,this.rasterX=0,this.rasterY=0,this.currentPixel=0}read(e){return 0}write(e,r){}}const Ye=[[0,0,0],[255,255,255],[136,0,0],[170,255,238],[204,68,204],[0,204,85],[0,0,170],[238,238,119],[221,136,85],[102,68,0],[255,119,119],[51,51,51],[119,119,119],[170,255,102],[0,136,255],[187,187,187]];class as extends kt{constructor(r,s){super();a(this,"pixelsMulti",8);a(this,"scanLines",0);a(this,"allWidth",0);a(this,"cyclesPerLine",0);a(this,"c64colors");a(this,"borderX0",0);a(this,"borderY0",0);a(this,"borderX1",0);a(this,"borderY1",0);a(this,"backgroundX0",0);a(this,"backgroundY0",0);a(this,"backgroundX1");a(this,"backgroundY1");a(this,"totalCycles",0);a(this,"nextSpriteCheck",0);a(this,"gridCtx");a(this,"gridPixels");a(this,"gridData");a(this,"d018",0);a(this,"colorBase",0);a(this,"textBase",0);a(this,"charsetBase",0);a(this,"gfxBase",0);a(this,"vicBank",0);a(this,"d01a",0);a(this,"d01b",0);a(this,"d01c",0);a(this,"d01d",0);a(this,"rasterIRQEnabled",!1);a(this,"borderColor",0);a(this,"borderRGB",[0,0,0]);a(this,"backgroundColor",0);a(this,"backgroundRGB",[0,0,0]);a(this,"rasterIRQLine",0);a(this,"interruptStatusRegister",0);a(this,"bitmapMode",!1);a(this,"extendedMode",!1);a(this,"multicolorMode",!1);a(this,"backgroundColor1",0);a(this,"backgroundColor2",0);a(this,"backgroundColor3",0);a(this,"multiColor1",0);a(this,"multiColor2",0);a(this,"sprites");a(this,"spriteRenderNeeded");a(this,"d010",0);a(this,"d011",0);a(this,"d015",0);a(this,"d016",0);a(this,"d017",0);a(this,"backgroundCollision",0);a(this,"spriteCollision",0);a(this,"requestIRQ",!1);this.c64colors=Ye,this.initRegs(),this.frames=0,this.memory=r,this.setBorder(0),this.setBackground(1),this.setRenderer(this.renderStandard8),Object.keys(s).forEach(i=>{this[i]=s[i]}),this.backgroundX1=this.backgroundX0+320,this.backgroundY1=this.backgroundY0+200,this.allWidth=this.cyclesPerLine*this.pixelsMulti,this.onscreenWidth=this.borderX1-this.borderX0,this.onscreenHeight=this.borderY1-this.borderY0,this.onscreenPixels=this.onscreenWidth*this.onscreenHeight,this.imageData=new ImageData(this.onscreenWidth,this.onscreenHeight),this.screenBuffer=this.imageData.data,this.totalCycles=this.scanLines*this.allWidth>>3,this.sprites=[];for(let i=0;i<8;i++){const n=new pe(i);this.sprites.push(n)}this.reset(),this.spriteRenderNeeded=[]}initRegs(){this.colorBase=55296,this.textBase=1024,this.gfxBase=0,this.vicBank=0,this.charsetBase=4096,this.d010=0,this.d016=0,this.d017=0,this.d018=0,this.d01a=0,this.d01b=0,this.d01c=0,this.d01d=0,this.rasterIRQEnabled=!1,this.interruptStatusRegister=0,this.bitmapMode=!1,this.extendedMode=!1,this.multicolorMode=!1,this.backgroundColor1=0,this.backgroundColor2=0,this.backgroundColor3=0,this.backgroundCollision=0,this.spriteCollision=0,this.rasterIRQLine=0,this.requestIRQ=!1}reset(){kt.prototype.reset.call(this),this.nextSpriteCheck=50}setVicBank(r){this.vicBank=r,this.textBase=(this.textBase&16383)+r*16384,this.gfxBase=(this.gfxBase&16383)+r*16384,this.charsetBase=(this.charsetBase&16383)+r*16384}initRowBlocks(){if(this.rasterY>=this.nextSpriteCheck){const r=[],[s,i]=this.rasterToSpritePos(),n=24;for(let o=0;o<8;o++)this.sprites[o].visible&&this.sprites[o].y<=i+n&&this.sprites[o].y1>=i&&r.unshift(this.sprites[o]);this.spriteRenderNeeded=r,this.nextSpriteCheck+=8}}isImage(){return this.backgroundX0<=this.rasterX&&this.rasterX<this.backgroundX1&&this.backgroundY0<=this.rasterY&&this.rasterY<this.backgroundY1}isVisible(){return this.borderX0<=this.rasterX&&this.rasterX<this.borderX1&&this.borderY0<=this.rasterY&&this.rasterY<this.borderY1}setVicMemory(r,s){const i=(r&49152)>>14,n=(r&16383)>>10,o=(s&49152)>>14;if(i!==o)throw Error("Invalid address combination!");const c=(s&16383)>>10<<4|n;this.bus.write(53272,c);const d=3-(i&3);this.bus.write(56576,d)}read(r){switch(r){case 53248:case 53250:case 53252:case 53254:case 53256:case 53258:case 53260:case 53262:{const s=(r&15)>>1;return this.sprites[s].x&255}case 53249:case 53251:case 53253:case 53255:case 53257:case 53259:case 53261:case 53263:{const s=(r&15)>>1;return this.sprites[s].y&255}case 53264:return this.d010;case 53265:return this.d011&127|this.rasterY&128;case 53266:return this.rasterY&255;case 53269:return this.d015;case 53270:return this.d016;case 53271:return this.d017;case 53272:return this.d018;case 53273:return(this.interruptStatusRegister&15)+(this.interruptStatusRegister?128:0);case 53274:return this.d01a;case 53275:return this.d01b;case 53276:return this.d01c;case 53277:return this.d01d;case 53278:return this.spriteCollision;case 53279:return this.backgroundCollision;case 53280:return this.borderColor;case 53281:return this.backgroundColor;case 53282:return this.backgroundColor1;case 53283:return this.backgroundColor2;case 53284:return this.backgroundColor3;case 53285:return this.multiColor1;case 53286:return this.multiColor2;case 53287:case 53288:case 53289:case 53290:case 53291:case 53292:case 53293:case 53294:{const s=r-53287;return this.sprites[s].colorCode}default:return 0}}write(r,s){if(r>=55296&&r<=56319)throw Error("Should not be here!");switch(r){case 53248:case 53250:case 53252:case 53254:case 53256:case 53258:case 53260:case 53262:{const i=(r&15)>>1;this.sprites[i].setPos({x:(this.sprites[i].x&256)+s});break}case 53249:case 53251:case 53253:case 53255:case 53257:case 53259:case 53261:case 53263:{const i=(r&15)>>1;this.sprites[i].setPos({y:s});break}case 53264:pe.prototype.bitIterator(this.sprites,s,(i,n)=>{i.setPos({x:(i.x&255)+(n==1?256:0)})}),this.d010=s;break;case 53265:this.extendedMode=(s&64)>0,this.bitmapMode=(s&32)>0,this.d011=s,this.rasterIRQLine=(this.rasterIRQLine&255)+(s&128?256:0);break;case 53266:this.rasterIRQLine=(this.rasterIRQLine&256)+s;break;case 53269:pe.prototype.bitIterator(this.sprites,s,(i,n)=>{i.visible=n==1}),this.d015=s;break;case 53270:this.multicolorMode=(s&16)>0,this.d016=s;break;case 53271:pe.prototype.bitIterator(this.sprites,s,(i,n)=>{i.doubleHeight=n==1,i.setPos({})}),this.d017=s;break;case 53272:{this.d018=s;const i=((s&14)>>1)*2048;this.charsetBase=(this.charsetBase&49152)+i;const n=((s&14)>>3)*8192;this.gfxBase=(this.gfxBase&49152)+n;const o=((s&240)>>4)*1024;this.textBase=(this.textBase&49152)+o;break}case 53273:this.interruptStatusRegister&=240+(15-(s&15));break;case 53274:this.d01a=s,s&1&&(this.rasterIRQEnabled=!0);break;case 53275:pe.prototype.bitIterator(this.sprites,s,(i,n)=>{i.behindText=n==1}),this.d01b=s;break;case 53276:pe.prototype.bitIterator(this.sprites,s,(i,n)=>{i.multiColor=n==1}),this.d01c=s;break;case 53277:pe.prototype.bitIterator(this.sprites,s,(i,n)=>{i.doubleWidth=n==1,i.setPos({})}),this.d01d=s;break;case 53278:this.spriteCollision=0;break;case 53279:this.backgroundCollision=0;break;case 53280:this.setBorder(s);break;case 53281:this.setBackground(s);break;case 53282:this.backgroundColor1=s;break;case 53283:this.backgroundColor2=s;break;case 53284:this.backgroundColor3=s;break;case 53285:this.multiColor1=s;break;case 53286:this.multiColor2=s;break;case 53287:case 53288:case 53289:case 53290:case 53291:case 53292:case 53293:case 53294:{const i=r-53287;this.sprites[i].colorCode=s;break}}}setBorder(r){this.borderColor=r,this.borderRGB=Ye[r&15]}setBackground(r){this.backgroundColor=r,this.backgroundRGB=Ye[r&15]}setPixelOld(r){const s=this.currentPixel<<2;this.screenBuffer[s]=r[0],this.screenBuffer[s+1]=r[1],this.screenBuffer[s+2]=r[2],this.screenBuffer[s+3]=255,this.currentPixel++}setPixel(r){const[s,i,n]=Ye[r&15],o=this.currentPixel<<2;this.screenBuffer[o]=s,this.screenBuffer[o+1]=i,this.screenBuffer[o+2]=n,this.screenBuffer[o+3]=255,this.currentPixel++}showDebugLine(r=16){const s=this.currentPixel-r<<2;if(this.currentPixel>=r)for(let i=0;i<r;i++)this.screenBuffer[s+1+i*4]^=255}isRendered(){return isNaN(this.cycleCount)&&(this.cycleCount=0),this.cycleCount>=this.totalCycles?(this.cycleCount=0,this.frames++,this.dummyIRQ(),!0):!1}rasterToSpritePos(){return[this.rasterX-this.backgroundX0+24,this.rasterY-this.backgroundY0+50]}dummyIRQ(){}renderSpritePixel(){if(this.spriteRenderNeeded.length>0){let r=-1;const[s,i]=this.rasterToSpritePos(),n=[];if(this.spriteRenderNeeded.forEach(o=>{if(o.x<=s&&o.x1>s&&o.y<=i&&o.y1>i){const l=this.memory.read(this.textBase+1024-8+o.id);o.shape=l;let c=s-o.x,d=i-o.y;o.doubleWidth&&(c=c>>1),o.doubleHeight&&(d=d>>1);const h=(this.textBase&49152)+l*64,u=this.memory.read(h+(c>>3)+d*3);o.dataStart=h,o.data[(c>>3)+d*3]=u;let x=0,p=-1;o.multiColor?(x=u>>6-(c&6)&3,p=[-1,this.multiColor1,o.colorCode,this.multiColor2][x]):(x=u>>7-(c&7)&1,p=x==1?o.colorCode:-1),p!=-1&&(n.push(o.id),r=p)}}),n.length>1){this.spriteCollision=0;for(let o=0;o<n.length;o++)this.spriteCollision|=2**n[o]}return r}return-1}newRasterLine(){this.rasterIRQEnabled&&this.rasterY==this.rasterIRQLine&&(this.interruptStatusRegister|=129,this.requestIRQ=!0)}renderStandard8(){if(this.showDebugLine(),this.rasterX++,this.rasterX>=this.allWidth&&(this.rasterY++,this.rasterX=1,this.newRasterLine()),this.rasterY>this.scanLines&&this.reset(),!this.isVisible()){this.rasterX+=7;return}if(!this.isImage()){this.rasterX--;for(let L=0;L<8;L++)this.rasterX++,this.setPixel(this.borderColor);return}this.backgroundY0<=this.rasterY&&this.nextSpriteCheck==50&&this.initRowBlocks(),this.rasterX--;const r=this.rasterX-this.backgroundX0,s=this.rasterY-this.backgroundY0,i=(r>>3)+(s>>3)*40,n=s&7;let o=r&7,l=this.backgroundColor,c,d,h=0,u=this.memory.vic_read(i+this.textBase);const x=this.memory.colorRam.read(i+this.colorBase),p=u&15,m=u>>4;this.bitmapMode?(c=this.memory.vic_read(i+this.textBase),d=this.memory.vic_read(i*8+this.gfxBase+n),l=c&15,c=c>>4):(c=x,this.extendedMode&&(h=u>>6,u&=63),d=this.memory.vic_read(u*8+this.charsetBase+n));for(let L=0;L<8;L++){let g=l,w=!1;this.rasterX++;const M=this.renderSpritePixel();if(this.multicolorMode&&!this.bitmapMode){const A=o&6,O=ye[A]+ye[A+1];(d&O)>0&&((d&O)>>6-A==1?c=this.backgroundColor1:(d&O)>>6-A==2&&(c=this.backgroundColor2),g=c&15)}else if(this.multicolorMode&&this.bitmapMode){const A=o&6,O=ye[A]+ye[A+1],N=(d&O)>>6-A;N==0?c=this.backgroundColor:N==1?c=m:N==2?c=p:N==3&&(c=x),g=c&15}else this.extendedMode?(d&ye[o]||(c=this.memory.io.read(53281+h)),g=c&15):(d&ye[o])>0&&(g=c&15,w=!0);M>-1&&(w&&(this.backgroundCollision=1),g=M&15),this.setPixel(g),o++}}}const os={pixelsMulti:8,scanLines:312,cyclesPerLine:63,borderX0:96,borderY0:16,borderX1:480,borderY1:288,backgroundX0:128,backgroundY0:51};class cs extends as{constructor(e){super(e,os)}}const je=class je{constructor(e){this.keyboard=e,e.setMapping(je.keyMapping)}keyDown(e){e.preventDefault(),this.keyboard.setMatrixFromEvent(e)}keyUp(e){e.preventDefault(),this.keyboard.clearMatrixFromEvent(e)}keyPress(e){}};a(je,"keyMapping",{Enter:"RETURN"," ":"SPACE",Backspace:"DELETE",ArrowRight:"CRSR_RT",ArrowDown:"CRSR_DN",ArrowUp:["CRSR_DN","LSHIFT"],ArrowLeft:["CRSR_RT","LSHIFT"],Home:"HOME",Shift:"LSHIFT",Control:"STOP",Alt:"C=",Tab:"CTRL",Escape:"<-",Pause:"RESTORE","!":["LSHIFT","1"],'"':["LSHIFT","2"],"#":["LSHIFT","3"],$:["LSHIFT","4"],"%":["LSHIFT","5"],"&":["LSHIFT","6"],"'":["LSHIFT","7"],"(":["LSHIFT","8"],")":["LSHIFT","9"],"+":"+","-":"-","*":"*",":":":","?":["LSHIFT","/"]});let lt=je;class ls{constructor(e="emu-canvas"){a(this,"canvas");a(this,"cssWidth",0);a(this,"cssHeight",0);this.id=e}getCanvas(){return this.canvas}setCanvasSize(e,r){this.cssWidth=e,this.cssHeight=r,this.canvas.style.width=e+"px",this.canvas.style.height=r+"px"}}class ds{read(e){switch(e){case 0:return 127;case 1:return 255;default:throw Error("Invalid joystick port!")}}}const Ne=class Ne{constructor(){a(this,"matrix",[]);a(this,"directionA",1);a(this,"directionB",1);a(this,"mask",0);a(this,"keysDown",new Set);a(this,"keyMapping",{});this.clearAll()}keyToKey2(e){if(Object.keys(this.keyMapping).indexOf(e)>=0)return this.keyMapping[e];if(e.length==1)return e.toUpperCase()}setMapping(e){this.keyMapping=e}clearAll(){this.matrix=Array(8).fill(0),this.keysDown=new Set}setMatrix(e){const r=document.getElementById("emulator-keys-display");r&&(r.innerText=Array.from(this.keysDown).join(" ")),this.matrix=Array(8).fill(0),(e.has("+")||e.has("-")||e.has(":")||e.has(";")||e.has("/")||e.has("*")||e.has("@")||e.has("=")||e.has("$")||e.has(";")||e.has("?"))&&(["Shift","Alt","Control","AltGraph"].forEach(s=>{e.delete(s),this.keysDown.delete(s)}),setTimeout(()=>{this.keysDown.clear()},200)),e.forEach(s=>{const i=this.keyToKey2(s);let n=[];typeof i=="string"?n=[i]:n=i,n&&n.forEach(o=>{if(o&&Object.keys(Ne.keyCodes).indexOf(o)>=0){const[l,c]=Ne.keyCodes[o];this.matrix[l]|=c}})})}setMatrixFromEvent(e){this.keysDown.add(e.key),this.setMatrix(this.keysDown)}clearMatrixFromEvent(e){this.keysDown.delete(e.key),this.setMatrix(this.keysDown)}clearKeys(){this.keysDown.clear()}getMasked(){let e=0,r=this.mask;for(let s=0;s<8;s++)r&1&&(e|=this.matrix[s]),r=r>>1;return e}read(e){switch(e){case 56320:return 0;case 56321:if(this.directionA)return this.getMasked()^255;break;default:return 0}return 0}write(e,r){switch(e){case 56320:this.directionA&&(this.mask=r^255);break;case 56321:this.directionA;break}}};a(Ne,"keyCodes",{STOP:[7,128],Q:[7,64],"C=":[7,32],SPACE:[7,16],2:[7,8],CTRL:[7,4],"<-":[7,2],1:[7,1],"/":[6,128],"^":[6,64],"=":[6,32],RSHIFT:[6,16],HOME:[6,8],";":[6,4],"*":[6,2],"£":[6,1],",":[5,128],"@":[5,64],":":[5,32],".":[5,16],"-":[5,8],L:[5,4],P:[5,2],"+":[5,1],N:[4,128],O:[4,64],K:[4,32],M:[4,16],0:[4,8],J:[4,4],I:[4,2],9:[4,1],V:[3,128],U:[3,64],H:[3,32],B:[3,16],8:[3,8],G:[3,4],Y:[3,2],7:[3,1],X:[2,128],T:[2,64],F:[2,32],C:[2,16],6:[2,8],D:[2,4],R:[2,2],5:[2,1],LSHIFT:[1,128],E:[1,64],S:[1,32],Z:[1,16],4:[1,8],A:[1,4],W:[1,2],3:[1,1],CRSR_DN:[0,128],F5:[0,64],F3:[0,32],F1:[0,16],F7:[0,8],CRSR_RT:[0,4],RETURN:[0,2],DELETE:[0,1]});let dt=Ne;const wt={start:0,data:[]};var we=(t=>(t[t.RUNNING=0]="RUNNING",t[t.STOPPED=1]="STOPPED",t[t.DEBUG=2]="DEBUG",t))(we||{});class hs{constructor(){a(this,"state");a(this,"clock");a(this,"cpu");a(this,"cia1");a(this,"bus");a(this,"vic");a(this,"view");a(this,"keypressHandler");a(this,"breakpoints",[])}restart(){this.bus.memoryManager.resetRAM(),this.cpu.reset(),this.vic.reset(),this.cpu.setPc(64738),this.run()}addEventListener(e,r){Object.entries(e).forEach(([s,i])=>{var n;s=="pc"&&((n=this.clock.pcCallbacks)[i]||(n[i]=[]),this.clock.pcCallbacks[i].push(r))})}removeEventListener(e,r){Object.entries(e).forEach(([s,i])=>{s=="pc"&&(this.clock.pcCallbacks[i]=this.clock.pcCallbacks[i].filter(n=>n!==r))})}setViewWithCanvasId(e){this.view=new ls}setViewSize(e,r){this.view.setCanvasSize(e,r)}init(){this.bus=new rr,this.clock=new or,this.cia1=new ar(this.bus),this.vic=new cs(this.bus.memoryManager),this.bus.addCPU(this.cpu),this.bus.addClock(this.clock),this.clock.addBus(this.bus),this.cpu.addBus(this.bus),this.bus.addVIC(this.vic),this.bus.addCIA1(this.cia1),this.bus.addKeyboard(new dt),this.bus.addJoystick(new ds),this.keypressHandler=new lt(this.bus.keyboard);const e=[],r=[],s=[],i={romCharset:new xt(e),kernal:new ut(r),basicRom:new ft(s),io:new tr(this.vic)};this.bus.memoryManager.setOptions(i),this.state=1}setROMS(e){this.bus.memoryManager.setOptions(e),this.restart()}getData(e,r,s){return wt}getDataFromRam(e,r){return wt}sendKeys(e){}setDataInRam(e){const{start:r,data:s}=e;for(let i=0;i<s.length;i++){const n=r+i,o=s[i];this.bus.write(n,o,!1)}}setDataInIO(e){}getByte(e,r){return this.bus.memoryManager.readWithPLA(e,r.plaSetup,r.page||0)}getByteFromRam(e){return this.bus.memoryManager.readWithPLA(e,y.FULL_RAM,0)}setByteInRam(e,r){this.bus.write(e,r,!1)}setByteInIO(e,r){this.bus.write(e,r,!0)}setByteInCartRam(e,r,s){throw Error("Not implemented!")}run(){this.state=0}pause(){this.state=1}step(){this.renderNextInstruction(),this.state=1}renderNextInstruction(){this.clock.renderNext()}renderManyInstructions(e){for(let r=0;r<e;r++)this.clock.renderNext()}renderFullFrame(e){this.clock.renderFrame(e)}renderVIC(){this.clock.renderVIC()}debugNextInstruction(e){}debugManyInstructions(e,r){}debugFullFrame(e){}debugUntilBreakpoint(e){}mainLoop(){switch(this.state){case 0:{this.renderFullFrame(1);break}case 2:this.debugUntilBreakpoint(this.breakpoints),this.breakpoints&&this.breakpoints.indexOf(this.cpu.pc)!=-1&&(this.state=1);break}}paintOnCtx(e){e.putImageData(this.vic.getImageData(),0,0)}onLoaded(e){}resizeCanvas(e){e instanceof HTMLCanvasElement&&(e.width=this.vic.onscreenWidth,e.height=this.vic.onscreenHeight)}onKeyDown(e){e.preventDefault(),this.bus.keyboard.setMatrixFromEvent(e)}onKeyUp(e){e.preventDefault(),this.bus.keyboard.clearMatrixFromEvent(e)}clearKeys(){this.bus.keyboard.clearKeys()}loadFile(){}}class xs extends hs{constructor(){super(),this.cpu=new cr}onLoaded(e){[42638,42291,42615].forEach(s=>{this.cpu.sysCall(s)});const r=e.start+e.data.length+5;[46,48,50].forEach(s=>{this.cpu.write(s,r>>8),this.cpu.write(s-1,r&255)})}}class me{static encodeTextAsBytes(e){return[0]}static voidEncoder(e){return[]}}class z{static screenCodeToChar(e,r=!1){return r?[`@ABCDEFGHIJKLMNOPQRSTUVWXYZ[£]↑← !"#$%&'()*+,-./0123456789:;<=>?━♠│─▔▔▁▍▕╮╰╯└╲╱┌┐●▁♥▏╭╳○♣▕♦➕⡇|.. ▌▄‾▁▎▒▕⣤.▕┣▗┗┓▂┏┻┳┫▎▍▐‾▀▃.▖▝┛▘▚`[e&127],(e&128)>0]:[`@abcdefghijklmnopqrstuvwxyz[£]↑← !"#$%&'()*+,-./0123456789:;<=>?━ABCDEFGHIJKLMNOPQRSTUVWXYZ➕⡇|π◥ ▌▄‾▁▎▒▕⣤◤▕┣▗┗┓▂┏┻┳┫▎▍▐‾▀▃⅃▖▝┛▘▚`[e&127],(e&128)>0]}static petsciiCodeToScreen(e){let r=0;return e<32?r=e+128:32<=e&&e<64?r=e:64<=e&&e<96?r=e-64:96<=e&&e<128?r=e-32:128<=e&&e<160?r=e+64:160<=e&&e<192?r=e-64:192<=e&&e<224||224<=e&&e<255?r=e-128:e==255&&(r=94),r}static textToPetscii(e){let r=e.charCodeAt(0);return(65<=r&&r<=90||97<=r&&r<=122)&&(r^=32),r}static textToScreen(e){const r=z.textToPetscii(e);return z.petsciiCodeToScreen(r)}static petsciiCodeToChar(e,r=!1){return z.screenCodeToChar(z.petsciiCodeToScreen(e),r)}static screenCodeToEscaped(e,r=!1){if(r)throw Error("Small character conversion not implemented!");return e==64||e>=91?["code",e]:["chr",`@abcdefghijklmnopqrstuvwxyz[£]↑← !"#$%&'()*+,-./0123456789:;<=>?━ABCDEFGHIJKLMNOPQRSTUVWXYZ`[e]]}static petsciiCodeToEscaped(e,r=!1){const s=z.petsciiCodeToScreen(e),i=z.screenCodeToEscaped(s,r);return i[0]=="code"&&(i[1]=e),i}static petsciiCodeToSafe(e,r=!1){const[s,i]=z.petsciiCodeToEscaped(e,r);return s=="chr"?i:"?"}}const We={locate:[128,130],read:[129,128],break:[130,192],call:[131,128],def:[132,160],endif:[133,192],for:[134,160],goto:[135,129],local:[136,128],if:[137,176],fend:[138,192],clr:[139,128],let:[140,128],memset:[141,130],next:[142,192],on:[143,128],poke:[144,129],continue:[145,192],repeat:[146,160],set:[147,128],then:[148,192],until:[149,129],voice:[150,136],while:[151,129],exec:[152,129],input:[153,129],sys:[154,128],CHAR:[160,0],F08:[161,24],DQUOTE:[162,2],WORD:[163,21],UWORD:[164,17],F2416:[165,30],BYTE:[166,16],SQUOTE:[167,2],F88:[168,29],FLOAT:[169,31],DCHAR:[170,1],inc:[171,128],QQUOTE:[172,2],dec:[173,128],_label:[174,128],rem:[175,128],"+":[176,34],"-":[177,34],"*":[178,35],AND:[179,32],"&&":[179,32],div:[180,35],"/":[180,35],OR:[181,32],"||":[181,32],mod:[182,35],"%":[182,35],xor:[183,36],"^":[183,36],and:[184,36],"&":[184,36],or:[185,36],"|":[185,36],"<":[186,33],"==":[187,33],"=":[187,33],">=":[188,33],"!=":[189,33],"<>":[189,33],"<=":[190,33],">":[191,33],print:[192,128],data:[193,128],bitmap:[194,136],fcall:[195,128],dend:[196,192],else:[197,144],fast:[198,160],gosub:[199,129],elif:[200,144],dim:[201,160],open:[202,128],color:[203,130],loop:[204,192],memcopy:[205,130],end:[206,192],do:[207,224],dpoke:[208,129],close:[209,129],return:[210,129],sprite:[211,136],timer:[212,128],get:[213,128],font:[214,136],wait:[215,130],inkey:[217,128],settings:[218,128],to:[220,64],pi:[222,64],right:[223,98],_lf:[224,192],cos:[225,97],int:[226,97],tan:[227,97],addr:[228,64],sgn:[229,97],limit:[230,98],mid:[231,98],step:[232,64],fpi:[233,64],atn:[234,97],frac:[235,97],dpeek:[236,98],spc:[237,97],sin:[238,97],peek:[239,98],abs:[240,97],left:[241,98],rnd:[242,98],when:[243,98],has:[244,98],tab:[245,97],len:[246,97],time:[247,64],sub:[248,96],ord:[249,97],_sh_lf:[250,0],fn:[251,64],chr:[252,97],find:[253,96],val:[254,97],between:[255,98]},us={128:["locate",130],129:["read",128],130:["break",192],131:["call",128],132:["def",160],133:["endif",192],134:["for",160],135:["goto",129],136:["local",128],137:["if",176],138:["fend",192],139:["clr",128],140:["let",128],141:["memset",130],142:["next",192],143:["on",128],144:["poke",129],145:["continue",192],146:["repeat",160],147:["set",128],148:["then",192],149:["until",129],150:["voice",136],151:["while",129],152:["exec",129],153:["input",129],154:["sys",128],160:["CHAR",0],161:["F08",24],162:["DQUOTE",2],163:["WORD",21],164:["UWORD",17],165:["F2416",30],166:["BYTE",16],167:["SQUOTE",2],168:["F88",29],169:["FLOAT",31],170:["DCHAR",1],171:["inc",128],172:["QQUOTE",2],173:["dec",128],174:["_label",128],175:["rem",128],176:["+",34],177:["-",34],178:["*",35],179:["&&",32],180:["/",35],181:["||",32],182:["%",35],183:["^",36],184:["&",36],185:["|",36],186:["<",33],187:["=",33],188:[">=",33],189:["<>",33],190:["<=",33],191:[">",33],192:["print",128],193:["data",128],194:["bitmap",136],195:["fcall",128],196:["dend",192],197:["else",144],198:["fast",160],199:["gosub",129],200:["elif",144],201:["dim",160],202:["open",128],203:["color",130],204:["loop",192],205:["memcopy",130],206:["end",192],207:["do",224],208:["dpoke",129],209:["close",129],210:["return",129],211:["sprite",136],212:["timer",128],213:["get",128],214:["font",136],215:["wait",130],217:["inkey",128],218:["settings",128],220:["to",64],222:["pi",64],223:["right",98],224:["_lf",192],225:["cos",97],226:["int",97],227:["tan",97],228:["addr",64],229:["sgn",97],230:["limit",98],231:["mid",98],232:["step",64],233:["fpi",64],234:["atn",97],235:["frac",97],236:["dpeek",98],237:["spc",97],238:["sin",97],239:["peek",98],240:["abs",97],241:["left",98],242:["rnd",98],243:["when",98],244:["has",98],245:["tab",97],246:["len",97],247:["time",64],248:["sub",96],249:["ord",97],250:["_sh_lf",0],251:["fn",64],252:["chr",97],253:["find",96],254:["val",97],255:["between",98]},fs={print:[192,128],locate:[128,130],inc:[171,128],dec:[173,128],let:[140,128],set:[147,128],for:[134,160],next:[142,192],repeat:[146,160],if:[137,176],then:[148,192],endif:[133,192],else:[197,144],elif:[200,144],do:[207,224],loop:[204,192],while:[151,129],until:[149,129],fast:[198,160],fcall:[195,128],fend:[138,192],poke:[144,129],dpoke:[208,129],read:[129,128],def:[132,160],call:[131,128],dend:[196,192],goto:[135,129],gosub:[199,129],on:[143,128],return:[210,129],end:[206,192],clr:[139,128],dim:[201,160],local:[136,128],inkey:[217,128],sys:[154,128],wait:[215,130],input:[153,129],timer:[212,128],memcopy:[205,130],memset:[141,130],color:[203,130],data:[193,128],exec:[152,129],open:[202,128],get:[213,128],close:[209,129],break:[130,192],continue:[145,192],sprite:[211,136],voice:[150,136],bitmap:[194,136],font:[214,136],settings:[218,128]},_s={print:192,locate:128,inc:171,dec:173,let:140,set:147,for:134,next:142,repeat:146,if:137,then:148,endif:133,else:197,elif:200,do:207,loop:204,while:151,until:149,fast:198,fcall:195,fend:138,poke:144,dpoke:208,read:129,def:132,call:131,dend:196,goto:135,gosub:199,on:143,return:210,end:206,clr:139,dim:201,local:136,inkey:217,sys:154,wait:215,input:153,timer:212,memcopy:205,memset:141,color:203,data:193,exec:152,open:202,get:213,close:209,break:130,continue:145,sprite:211,voice:150,bitmap:194,font:214,settings:218},it={BYTE:{shortCode:"b",longCode:"BYTE",tokenValue:166,type_value:16,rangeMin:0,rangeMax:256,description:"8bit integer number, values: 0..255"},WORD:{shortCode:"W",longCode:"WORD",tokenValue:163,type_value:21,rangeMin:-32768,rangeMax:32768,description:"16bit signed integer number, values: -32768..32767"},UWORD:{shortCode:"w",longCode:"UWORD",tokenValue:164,type_value:17,rangeMin:0,rangeMax:65536,description:"16bit unsigned integer number, values: 0..65535"},F08:{shortCode:"f",longCode:"F08",tokenValue:0,type_value:24,rangeMin:0,rangeMax:1,description:"8bit unsigned fractional number, values: 0.0..1.0"},F88:{shortCode:"S",longCode:"F88",tokenValue:0,type_value:29,rangeMin:-128,rangeMax:128,description:"16bit signed fractional number, values: -128.0..128.0"},F2416:{shortCode:"L",longCode:"F2416",tokenValue:165,type_value:30,rangeMin:null,rangeMax:null,description:"5 bytes signed number, 24bit integer and 16 bit fractional part"},FLOAT:{shortCode:"%",longCode:"FLOAT",tokenValue:0,type_value:31,rangeMin:null,rangeMax:null,description:"Legacy float number"},CHAR:{shortCode:"c",longCode:"CHAR",tokenValue:160,type_value:0,rangeMin:null,rangeMax:null,description:"8bit single character"},DCHAR:{shortCode:"d",longCode:"DCHAR",tokenValue:0,type_value:1,rangeMin:null,rangeMax:null,description:"16bit, 2 characters"},VARSTR:{shortCode:"$",longCode:"VARSTR",tokenValue:-1,type_value:2,rangeMin:null,rangeMax:null,description:"Variable length string - each operation creates a new item in memory. Data: [len][STR...]"},FIXSTR:{shortCode:"$",longCode:"FIXSTR",tokenValue:-1,type_value:3,rangeMin:null,rangeMax:null,description:"Fixed length string, always uses the same memory. Data: [maxlen][len][STR...][unused...]"},NONE:{shortCode:"0",longCode:"NONE",tokenValue:0,type_value:0,rangeMin:0,rangeMax:0,description:""},UBYTE:{shortCode:"b",longCode:"UBYTE",tokenValue:0,type_value:16,rangeMin:0,rangeMax:256,description:""},SBYTE:{shortCode:"B",longCode:"SBYTE",tokenValue:0,type_value:20,rangeMin:-128,rangeMax:128,description:""},SWORD:{shortCode:"W",longCode:"SWORD",tokenValue:0,type_value:21,rangeMin:-32768,rangeMax:32768,description:""},UF08:{shortCode:"f",longCode:"UF08",tokenValue:0,type_value:24,rangeMin:0,rangeMax:1,description:""},SF08:{shortCode:"F",longCode:"SF08",tokenValue:0,type_value:28,rangeMin:null,rangeMax:null,description:""},UF88:{shortCode:"s",longCode:"UF88",tokenValue:0,type_value:25,rangeMin:0,rangeMax:256,description:""},SF88:{shortCode:"S",longCode:"SF88",tokenValue:0,type_value:29,rangeMin:-128,rangeMax:128,description:""},UF2416:{shortCode:"l",longCode:"UF2416",tokenValue:0,type_value:26,rangeMin:null,rangeMax:null,description:""},SF2416:{shortCode:"L",longCode:"SF2416",tokenValue:0,type_value:30,rangeMin:null,rangeMax:null,description:""}},nt={b:{shortCode:"b",longCode:"UBYTE",tokenValue:0,type_value:16,rangeMin:0,rangeMax:256,description:""},W:{shortCode:"W",longCode:"SWORD",tokenValue:0,type_value:21,rangeMin:-32768,rangeMax:32768,description:""},w:{shortCode:"w",longCode:"UWORD",tokenValue:164,type_value:17,rangeMin:0,rangeMax:65536,description:"16bit unsigned integer number, values: 0..65535"},f:{shortCode:"f",longCode:"UF08",tokenValue:0,type_value:24,rangeMin:0,rangeMax:1,description:""},S:{shortCode:"S",longCode:"SF88",tokenValue:0,type_value:29,rangeMin:-128,rangeMax:128,description:""},L:{shortCode:"L",longCode:"SF2416",tokenValue:0,type_value:30,rangeMin:null,rangeMax:null,description:""},"%":{shortCode:"%",longCode:"FLOAT",tokenValue:0,type_value:31,rangeMin:null,rangeMax:null,description:"Legacy float number"},c:{shortCode:"c",longCode:"CHAR",tokenValue:160,type_value:0,rangeMin:null,rangeMax:null,description:"8bit single character"},d:{shortCode:"d",longCode:"DCHAR",tokenValue:0,type_value:1,rangeMin:null,rangeMax:null,description:"16bit, 2 characters"},$:{shortCode:"$",longCode:"FIXSTR",tokenValue:-1,type_value:3,rangeMin:null,rangeMax:null,description:"Fixed length string, always uses the same memory. Data: [maxlen][len][STR...][unused...]"},0:{shortCode:"0",longCode:"NONE",tokenValue:0,type_value:0,rangeMin:0,rangeMax:0,description:""},B:{shortCode:"B",longCode:"SBYTE",tokenValue:0,type_value:20,rangeMin:-128,rangeMax:128,description:""},F:{shortCode:"F",longCode:"SF08",tokenValue:0,type_value:28,rangeMin:null,rangeMax:null,description:""},s:{shortCode:"s",longCode:"UF88",tokenValue:0,type_value:25,rangeMin:0,rangeMax:256,description:""},l:{shortCode:"l",longCode:"UF2416",tokenValue:0,type_value:26,rangeMin:null,rangeMax:null,description:""}},ps={font_set_source0_target0:0,font_set_source0_target1:1,font_set_source1_target0:4,font_set_source1_target1:5,font_set_source_rom_target0:8,font_set_source_rom_target1:9,font_def_uncompressed_multi:16,font_def_uncompressed_1:17,font_def_uncompressed_2:18,font_def_uncompressed_3:19,font_def_uncompressed_4:20,font_def_uncompressed_5:21,font_def_uncompressed_6:22,font_def_uncompressed_7:23,font_copy_full:24,font_copy_lo:25,font_copy_hi:26,font_copy_range_same_index:27,font_copy_range:28,font_create_2x1:32,font_create_2x2:33,font_map_4x4_from:35,font_map_4x4_full:36,font_map_4x8_default:37,font_map_4x8_full:38,font_map_8x4_default:39,font_map_8x4_full:40,font_set_8x8_fill:41,font_use_1x1:48,font_use_2x1:49,font_use_2x2:50,font_use_4x4:51,font_use_4x8:52,font_use_8x4:53,font_use_8x8:54,font_invert_all:64,font_invert_range:65,font_create_from_spr_3x3:81,font_create_from_spr_3x2:82,font_create_from_spr_2x3:83,font_create_from_spr_2x2:84},ms={pi:[222,64],fpi:[233,64],to:[220,64],step:[232,64],peek:[239,98],dpeek:[236,98],rnd:[242,98],cos:[225,97],sin:[238,97],tan:[227,97],atn:[234,97],int:[226,97],frac:[235,97],ord:[249,97],chr:[252,97],when:[243,98],addr:[228,64],len:[246,97],val:[254,97],abs:[240,97],left:[241,98],mid:[231,98],right:[223,98],find:[253,96],sub:[248,96],time:[247,64],tab:[245,97],spc:[237,97],sgn:[229,97],fn:[251,64],has:[244,98],between:[255,98],limit:[230,98]},gs={type:["t",0,0],size:["S",0,0],addr:["@",0,0],word:["w",32,0],byte:["b",32,0],fx2:["f",32,0],fx5:["F",32,0],frac:["F×",32,0],chr:["$",48,16],str:["s",48,16],int:["i",48,16],abs:["a",48,16],sign:["n",48,16],rdn:["r",48,16],rup:["R",48,16],minus:["M×",48,16],plus:["P×",48,16],dbl:["d",48,16],div2:["D",48,16],ord:["o",48,0],ucase:["C",48,0],lcase:["c",48,0],lo:["l",0,0],hi:["h",0,0],lnib:["L",0,0],hnib:["H",0,0],lnib2:["L×",0,0],hnib2:["H×",0,0],getw:["G",24,16],getb:["g",24,16],avg:["A",32,32],sum:["S×",32,32],min:["m",255,1],max:["M",255,1],ix:["I×",255,1],jx:["J×",255,1],kx:["K×",255,1],push:["p",255,1],pop:["P",255,1],ax:["A×",255,1],axm:["x",255,1]},bs={tab:128,transparent:129,recolor_only:130,stop:131,scroll_actual_column:132,white:133,home_current_line:134,end_current_line:135,disable_c_shift:136,enable_c_shift:137,rep_next:138,rep_double:139,rep_between:140,return:141,lo_up_charset:142,scroll_circular_on:143,scroll_actual_line:144,down:145,reverse_on:146,home:147,delete:148,clear_line_content:149,remove_line:150,scroll_left:151,scroll_right:152,scroll_up:153,scroll_down:154,setx:155,red:156,right:157,green:158,blue:159,stamp_set_mode:160,stamp_use:161,stamp_use_last:162,window_start:163,window_stop:164,box_set_single:165,box_set_style:166,box_user_def:167,box_draw_filled:168,box_draw_empty:169,box_set_sides:170,box_box_filled_compr:171,box_box_empty_compr:172,use_fn:173,setxy:174,typewriter_mode:175,buffer_def:176,buffer_opt:177,buffer_copy:178,buffer_paste:179,input_rx:180,input_cursor:181,format_str:182,format_dec:183,format_hex:184,decompress:185,set_mode_a:186,set_mode_b:187,set_mode_c:188,scroll_set_area:189,scroll_window:190,scroll_screen:191,background:192,orange:193,border:194,run:195,sety:196,f1:197,f3:198,f5:199,f7:200,f2:201,f4:202,f6:203,f8:204,shift_return:205,up_gfx_charset:206,scroll_circular_off:207,black:208,up:209,reverse_off:210,clear:211,insert:212,brown:213,pink:214,dark_gray:215,gray:216,light_green:217,light_blue:218,light_gray:219,purple:220,cursor_left:221,yellow:222,cyan:223,set_addr0:224,set_addr1:225,set_addr2:226,set_addr3:227,push_one:228,push_two:229,push_multi:230,print_src_var:231,print_src_addr:232,print_db:233,print_dw:234,print_hb:235,print_hw:236,print_s:237,print_f:238,format_f:239,def_f1:240,def_f3:241,def_f5:242,def_f7:243,def_f2:244,def_f4:245,def_f6:246,def_f8:247,parambuff_susp:248,parambuff_on:249,parambuff_off:250,set_col_bckg:251,set_col_bord:252,set_col_bcbd:253,decode:254,extra_ff:255,pos_save:65281,pos_load:65282,qsys:65283,qsys_bank:65284,set_tab:65285,poke_single:65286,set_mem:65287,fill_mem:65288},at={0:"@",1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h",9:"i",10:"j",11:"k",12:"l",13:"m",14:"n",15:"o",16:"p",17:"q",18:"r",19:"s",20:"t",21:"u",22:"v",23:"w",24:"x",25:"y",26:"z",27:"[",29:"]",32:" ",33:"!",34:'"',35:"#",36:"$",37:"%",38:"&",39:"'",40:"(",41:")",42:"*",43:"+",44:",",45:"-",46:".",47:"/",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",58:":",59:";",60:"<",61:"=",62:">",63:"?",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",97:"K×",98:"I×",99:"T×",101:"G×",103:"M×",106:"N×",107:"Q×",108:"D×",109:"Z×",110:"S×",111:"P×",112:"A×",113:"E×",114:"R×",115:"W×",116:"H×",117:"J×",118:"L×",119:"Y×",120:"U×",121:"O×",123:"F×",124:"C×",125:"X×",126:"V×",127:"B×",28:"{POUND}",30:"{ARR UP}",31:"{ARR LEFT}",64:"{SH *}",91:"{SH +}",92:"{CM -}",93:"{SH -}",94:"{PI}",95:"{CM *}",96:"{SH SPACE}",100:"{CM @}",102:"{CM +}",104:"{CM POUND}",105:"{SH POUND}",122:"{SH @}"},Z={"@":0,a:1,b:2,c:3,d:4,e:5,f:6,g:7,h:8,i:9,j:10,k:11,l:12,m:13,n:14,o:15,p:16,q:17,r:18,s:19,t:20,u:21,v:22,w:23,x:24,y:25,z:26,"[":27,"]":29," ":32,"!":33,'"':34,"#":35,$:36,"%":37,"&":38,"'":39,"(":40,")":41,"*":42,"+":43,",":44,"-":45,".":46,"/":47,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,":":58,";":59,"<":60,"=":61,">":62,"?":63,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"K×":97,"I×":98,"T×":99,"G×":101,"M×":103,"N×":106,"Q×":107,"D×":108,"Z×":109,"S×":110,"P×":111,"A×":112,"E×":113,"R×":114,"W×":115,"H×":116,"J×":117,"L×":118,"Y×":119,"U×":120,"O×":121,"F×":123,"C×":124,"X×":125,"V×":126,"B×":127,"{POUND}":28,"{ARR UP}":30,"{ARR LEFT}":31,"{SH *}":64,"{SH +}":91,"{CM -}":92,"{SH -}":93,"{PI}":94,"{CM *}":95,"{SH SPACE}":96,"{CM @}":100,"{CM +}":102,"{CM POUND}":104,"{SH POUND}":105,"{SH @}":122,Ł:28,"^":30,"~":31,"<==":31,"<_":31,"<--":31},ys={spr_autoinc_0:0,spr_copy_idx:3,spr_rot_fill:4,spr_mirr_fill_multi:5,spr_mirr_fill_sing:6,spr_spec:15,spr_mirr_h_mult:16,spr_mirr_h_sing:17,spr_mirr_v:18,spr_rot90:19,spr_rot180_sing:20,spr_rot180_mult:21,spr_rot270:22,spr_rot90_mirr_h_sing:23,spr_rot90_mirr_v_sing:24,spr_sh_left_mult:26,spr_sh_right_mult:27,spr_sh_left_sing:28,spr_sh_right_sing:29,spr_sh_up:30,spr_sh_down:31,spr_def_raw:33,spr_copy:34,spr_def_cmp0:35,spr_def_cmp_base:36,spr_double_x:41,spr_double_y:42,spr_double_xy:43,spr_use_predef0:48,spr_use_predef1:49,spr_use_predef2:50,spr_use_predef3:51,spr_use_predef4:52,spr_use_predef5:53,spr_use_predef6:54,spr_use_predef7:55,spr_set_predef0:56,spr_set_predef1:57,spr_set_predef2:58,spr_set_predef3:59,spr_set_predef4:60,spr_set_predef5:61,spr_set_predef6:62,spr_set_predef7:63,spr_autoinc_S:64,spr_inc_S:65,spr_dec_S:66,spr_copy_idx_S:67,spr_rot_fill_S:68,spr_mirr_fill_multi_S:69,spr_mirr_fill_sing_S:70,spr_spec_S:79,spr_mirr_h_mult_S:80,spr_mirr_h_sing_S:81,spr_mirr_v_S:82,spr_rot90_S:83,spr_rot180_sing_S:84,spr_rot180_mult_S:85,spr_rot270_S:86,spr_rot90_mirr_h_sing_S:87,spr_rot90_mirr_v_sing_S:88,spr_sh_left_mult_S:90,spr_sh_right_mult_S:91,spr_sh_left_sing_S:92,spr_sh_right_sing_S:93,spr_sh_up_S:94,spr_sh_down_S:95,spr_set_idx_S:96,spr_def_raw_S:97,spr_copy_S:98,spr_def_cmp0_S:99,spr_def_cmp_base_S:100,spr_double_x_S:105,spr_double_y_S:106,spr_double_xy_S:107,spr_use_predef0_S:112,spr_use_predef1_S:113,spr_use_predef2_S:114,spr_use_predef3_S:115,spr_use_predef4_S:116,spr_use_predef5_S:117,spr_use_predef6_S:118,spr_use_predef7_S:119,spr_set_predef0_S:120,spr_set_predef1_S:121,spr_set_predef2_S:122,spr_set_predef3_S:123,spr_set_predef4_S:124,spr_set_predef5_S:125,spr_set_predef6_S:126,spr_set_predef7_S:127,spr_autoinc_T:128,spr_inc_T:129,spr_dec_T:130,spr_copy_idx_T:131,spr_rot_fill_T:132,spr_mirr_fill_multi_T:133,spr_mirr_fill_sing_T:134,spr_spec_T:143,spr_mirr_h_mult_T:144,spr_mirr_h_sing_T:145,spr_mirr_v_T:146,spr_rot90_T:147,spr_rot180_sing_T:148,spr_rot180_mult_T:149,spr_rot270_T:150,spr_rot90_mirr_h_sing_T:151,spr_rot90_mirr_v_sing_T:152,spr_sh_left_mult_T:154,spr_sh_right_mult_T:155,spr_sh_left_sing_T:156,spr_sh_right_sing_T:157,spr_sh_up_T:158,spr_sh_down_T:159,spr_set_idx_T:160,spr_def_raw_T:161,spr_copy_T:162,spr_def_cmp0_T:163,spr_def_cmp_base_T:164,spr_double_x_T:169,spr_double_y_T:170,spr_double_xy_T:171,spr_use_predef0_T:176,spr_use_predef1_T:177,spr_use_predef2_T:178,spr_use_predef3_T:179,spr_use_predef4_T:180,spr_use_predef5_T:181,spr_use_predef6_T:182,spr_use_predef7_T:183,spr_set_predef0_T:184,spr_set_predef1_T:185,spr_set_predef2_T:186,spr_set_predef3_T:187,spr_set_predef4_T:188,spr_set_predef5_T:189,spr_set_predef6_T:190,spr_set_predef7_T:191,spr_autoinc_TS:192,spr_inc_TS:193,spr_dec_TS:194,spr_copy_idx_TS:195,spr_rot_fill_TS:196,spr_mirr_fill_multi_TS:197,spr_mirr_fill_sing_TS:198,spr_spec_TS:207,spr_mirr_h_mult_TS:208,spr_mirr_h_sing_TS:209,spr_mirr_v_TS:210,spr_rot90_TS:211,spr_rot180_sing_TS:212,spr_rot180_mult_TS:213,spr_rot270_TS:214,spr_rot90_mirr_h_sing_TS:215,spr_rot90_mirr_v_sing_TS:216,spr_sh_left_mult_TS:218,spr_sh_right_mult_TS:219,spr_sh_left_sing_TS:220,spr_sh_right_sing_TS:221,spr_sh_up_TS:222,spr_sh_down_TS:223,spr_set_idx_TS:224,spr_def_raw_TS:225,spr_copy_TS:226,spr_def_cmp0_TS:227,spr_def_cmp_base_TS:228,spr_double_x_TS:233,spr_double_y_TS:234,spr_double_xy_TS:235,spr_use_predef0_TS:240,spr_use_predef1_TS:241,spr_use_predef2_TS:242,spr_use_predef3_TS:243,spr_use_predef4_TS:244,spr_use_predef5_TS:245,spr_use_predef6_TS:246,spr_use_predef7_TS:247,spr_set_predef0_TS:248,spr_set_predef1_TS:249,spr_set_predef2_TS:250,spr_set_predef3_TS:251,spr_set_predef4_TS:252,spr_set_predef5_TS:253,spr_set_predef6_TS:254,spr_set_predef7_TS:255},ge={SUPERSTRONG:192,STRONG:128,SUPER:64,NEXT_ADDR:32,BRANCH_ADDR:16,SUB_COMMAND:8,FN_WITH_BRACKET:32,EVAL_SINGLE:1,EVAL_ALL:2,EVAL_NOTHING:0,COMMAND:128,COMMAND_STRONG:192,FUNC:64,OPERATOR:32,TYPE:0,MASK:196,MASK_LONG:224},Te={a:1,b:2,c:3,d:4,e:5,f:6,g:7,h:8,i:9,j:10,k:11,l:12,m:13,n:14,o:15,p:16,q:17,r:18,s:19,t:20,u:21,v:22,w:23,x:24,y:25,z:26,A:27,B:28,C:29,D:30,E:31,F:32,G:33,H:34,I:35,J:36,K:37,L:38,M:39,N:40,O:41,P:42,Q:43,R:44,S:45,T:46,U:47,V:48,W:49,X:50,Y:51,Z:52,Ax:53,Bx:54,Cx:55,Dx:56,Ex:57,Fx:58,Gx:59,Hx:60,Ix:61,Jx:62,Kx:63,Lx:64,Mx:65,Nx:66,Ox:67,Px:68,Qx:69,Rx:70,Sx:71,Tx:72,Ux:73,Vx:74,Wx:75,Xx:76,Yx:77,Zx:78};var X;class b{}X=b;b.CTT_COMMAND_TOKENS=us;b.TTC_COMMAND_TOKENS=Object.fromEntries(Object.entries(We).map(([t,e])=>[t,e[0]]));b.TTC_SCREEN_TOKENS={...bs,...ys,...ps};b.TTC_STRING_TOKENS=X.TTC_SCREEN_TOKENS;b.TTC_STRING_TOKENS_UPPER=Object.fromEntries(Object.entries(X.TTC_STRING_TOKENS).map(([t,e])=>[t.toUpperCase(),e]));b.CTT_STRING_TOKENS=Object.fromEntries(Object.entries(X.TTC_STRING_TOKENS).filter(([t,e])=>t.indexOf("spr_")!==0).map(([t,e])=>[e,t]));b.EXTRA_ZEROS=Object.fromEntries(Object.entries(We).map(([t,e])=>{let r=0;return e[1]&ge.COMMAND&&e[1]&(ge.NEXT_ADDR|ge.BRANCH_ADDR)&&(e[1]&ge.NEXT_ADDR&&r++,e[1]&ge.BRANCH_ADDR&&r++),[t,r*2]}));b.IS_COMMAND=Object.fromEntries(Object.entries(We).map(([t,e])=>[t,!!(e[1]&ge.COMMAND)]));b.CTT_SPRITE_TOKENS=Object.fromEntries(Object.entries(X.TTC_STRING_TOKENS).filter(([t,e])=>t.indexOf("spr_")==0).map(([t,e])=>[e,t]));b.blockEndToken=X.TTC_COMMAND_TOKENS._lf;b.finalToken=X.TTC_COMMAND_TOKENS.end;b.strDQuote=X.TTC_COMMAND_TOKENS.DQUOTE;b.strSQuote=X.TTC_COMMAND_TOKENS.SQUOTE;b.strBQuote=X.TTC_COMMAND_TOKENS.SQUOTE;b.strQQuote=X.TTC_COMMAND_TOKENS.QQUOTE;b.cmdParams={...fs};b.gbFuncs={SETPOS(t,e){const r=parseInt(t,10)+parseInt(e,10)*40;return[X.TTC_SCREEN_TOKENS.set_addr0+(r>>8),r&255]}};class Ae{static getTokensFromMemory(e,r=2049){const s=function(c,d){return c+d*256},i=[];let n=0,o=r,l="";for(;n<e.length;){let x=function(p){if(u>=128){const m=b.CTT_COMMAND_TOKENS[u];if(!m)return;p.key=u>162?"func":"command",p.value=m,l=m}u>=65&&u<=90&&(p.key="identifier",p.value=p.escapedValue),u==32&&(p.key="whiteSpc",p.value=p.escapedValue)};if(o<n+r||o<r||o>r+e.length){console.log(`Invalid address ${o}`);break}if(n=o-r,o=s(e[n],e[n+1]),o==0)break;const c=s(e[n+2],e[n+3]);i.push({key:"label",value:c.toString(10),pos:n+r}),n+=4;let d;d=1;const h={key:"error",value:"error",escapedMode:"",escapedValue:""};let u=0;for(;n+r<o&&(u=e[n],u!=0);){switch(h.value="error",h.key="error",[h.escapedMode,h.escapedValue]=z.petsciiCodeToEscaped(u),d){case 1:x(h),d=3,h.value=="rem"&&(d=2);break;case 2:h.key="rem",h.value=h.escapedValue;break;case 0:if(h.escapedValue=='"'?(d=3,h.key="other"):h.key="strDQuote",h.escapedMode=="code"){const p=Ae.STR_CODES[l]||Ae.STR_CODES.print;h.value=p[u]?`{${p[u]}}`:`{${h.escapedValue}}`}else h.value=h.escapedValue;break;case 3:h.value=h.escapedValue,h.key="other",x(h),h.value=='"'?d=0:h.value==":"?d=1:(h.value>="0"&&h.value<="9"||h.value==".")&&(h.key="floatNum");break}i.push({key:h.key,value:h.value,pos:n+r}),n++}i.push({key:"newLines",value:`
`,pos:n+r})}return i}static tokenArrayToRepr(e){let r="";return e.forEach(s=>{r+=s.value}),r}}Ae.STR_CODES={print:b.CTT_STRING_TOKENS,sprite:b.CTT_SPRITE_TOKENS,font:b.CTT_STRING_TOKENS};class Y{static getGroups(e){const r={};return e===void 0||(e==null?void 0:e.groups)===void 0?{}:(Object.keys(e.groups).forEach(s=>{if(e.groups&&e.groups[s]!==void 0&&e.groups[s]!==""){const i=e.groups[s];r[s]=i}}),r)}static verboseRegexp(e,r){const s=new RegExp("(?<!\\\\)\\s|[/][/].*|[/][*][\\s\\S]*[*][/]","g"),i=e.replace(s,"");return new RegExp(i,r)}static convertSpecToBytes(e,r){const s=r.tokens||{},i=r.funcs||{},n=r.worldLH===void 0?!0:r.worldLH;r.useUppercase===void 0||r.useUppercase;const o=[];let l;function c(x,p=!1){return!p&&x<256?[x]:n?[x&255,x>>8&255]:[x>>8&255,x&255]}Y.STRING_PARSER.lastIndex=0;let d=1e4;const h=[];for(;l=Y.STRING_PARSER.exec(e);){if(d--,d<0)throw"Too many iterations!";const x=Y.getGroups(l),p=l[0];if(p===""||p==null)break;let m=[];if(x.deci!==void 0){const g=x.deci.trim();m=c(parseInt(g,10),g.slice(-1).toLowerCase()=="w")}else if(x.hexa!==void 0){const g=x.hexa.replace(/[$]|(0x)/,"");m=c(parseInt(g,16),g.slice(-1).toLowerCase()=="w")}else if(x.str_extra_fn!==void 0)if(i[x.str_extra_fn]===void 0){const g=Object.keys(i).map(M=>M.toLowerCase()),w=x.str_extra_fn.toLowerCase();if(g.includes(w)){const M=Object.keys(i)[g.indexOf(w)];m=i[M](...x.str_extra_fnparam.split(/,\s*/g))}else throw new Error(`Function not implemented: ${x.str_extra_fn}`)}else m=i[x.str_extra_fn](...x.str_extra_fnparam.split(/,\s*/g));else if(x.code!==void 0){if(s[x.code]!==void 0)m=s[x.code];else{m=s.undefined;const g=x.code.toLowerCase(),M=Object.keys(s).map(A=>A.toLowerCase()).indexOf(g);M>=0&&(m=Object.values(s)[M])}m===void 0&&(h.push({code:x.code,pos:(r.pos||0)+l.index}),m=[63])}else x.sep&&x.sep.trim()==","&&(m=[0]);let L=1;x.multi&&(L=parseInt(x.multi,10)),typeof m=="number"&&(m=[m]);for(let g=0;g<L;g++)o.push(...m)}const u=h.length>0?"ERROR":"OK";return{byteArray:o,status:u,invalidCodes:h}}static convertStringToBytes(e,r){const s=[],i=[];let n,o,l="OK";const c=r.normalConverter||(h=>String.prototype.charCodeAt.bind(h)(0)),d=/({[^}]+})|(.)/g;for(;n=d.exec(e);){const[h,u,x]=n;if(u){r.pos=n.index;const{byteArray:p,status:m,invalidCodes:L}=Y.convertSpecToBytes(u.slice(1,-1),r);m!=="OK"&&(l=m,i.push(...L)),s.push(...p)}else o=c(x),s.push(o)}return{byteArray:s,status:l,invalidCodes:i}}}Y.STRING_PARSER=Y.verboseRegexp(String.raw`
         (\s*?)(
          (?<rem>(([-]{2}|[/]{2}).*$)|[/][*][\s\S]*?[*][/]) |

          ( (?<str_extra_fn>\w+\s*)[(]
            (?<str_extra_fnparam>[^)][^)]*?)
            (?<str_extra_end>[)])
          ) |

          (
            (?<code>[a-zA-Z_][a-zA-Z_0-9]*) |
            (?<hexa>(?:[$]|0x)[0-9a-fA-F]+[w]{0,1}) |
            (?<deci>[0-9]+[w]{0,1})

          )?
          (?:[*]?)
          (?<multi>[0-9]+)?
          (?<sep>[,;]\s*|$|\s+)?
        )
        `,"gm");class Ss extends Array{}var j;(function(t){t.remark="remark",t.docstr="docstr",t.remMulti="remMulti",t.strDQuote="strDQuote",t.strSQuote="strSQuote",t.strBQuote="strBQuote",t.whiteSpc="whiteSpc",t.numHex="hexNum",t.numFloat="floatNum",t.numInt="intNum",t.identifier="identifier",t.other="other"})(j||(j={}));const Ts={remark:[1100,String.raw`(?<remark>\/\/.*$)`],remDash:[1150,String.raw`(?<remark>[\-]{2}.*$)`],docstr:[1200,String.raw`(?<docstr>\/[*]{2}[\S\s]*?[*]\/)`],remMulti:[1300,String.raw`(?<rem_multi>\/[*][\S\s]*?[*]\/)`],strDQuote:[2100,String.raw`(?<other__strDO>\")(?<strDQuote>[^\"]*?)(?<other__strDC>\")`],strSQuote:[2200,String.raw`(?<other__strSO>\')(?<strSQuote>[^\']*?)(?<other__strSC>\')`],strBQuote:[2300,String.raw`(?<other__strBO>\`)(?<strBQuote>[^\`]*?)(?<other__strBC>\`)`],whiteSpc:[3100,String.raw`(?<whiteSpc>\s+)`],hexNum:[4100,String.raw`(?<hexNum>(0x[0-9a-f]+))`],floatNum:[4200,String.raw`(?<floatNum>(\d*[.]\d*))`],intNum:[4300,String.raw`(?<intNum>(\d+))`],identifier:[8100,String.raw`(?<identifier>[\w.]+)`]};class ${constructor(e){if(!e.TokenClass||!e.splitFunc||!e.rxPattern)throw Error("Invalid TokenizerSettings object. Use class to create one!");this.settings=e,this.TokenClass=this.settings.TokenClass,this.rxPattern=new RegExp(this.settings.rxPattern,"gm"),Object.keys(e.subFormatPatterns).length>0?this.subFormatPatterns=Object.fromEntries(Object.entries(e.subFormatPatterns).map(([r,s])=>[r,$.convertTokenizerFunction(s)])):this.subFormatPatterns={},this.rawText="",this.tokens=new Ss,this.linePosTable=[],this.tokenizedRaw=""}reset(){this.tokens=[],this.linePosTable=[]}static convertTokenizerFunction(e){return typeof e=="string"?$.verboseRegexp(e,"gm"):e}static verboseRegexp(e,r){const s=new RegExp("(?<!\\\\)\\s|[/][/].*|[/][*][\\s\\S]*[*][/]","g"),i=e.replace(s,"");return new RegExp(i,r)}static buildRxString(e,r=null,s="(?<other>.)"){const i=[];e.forEach(l=>{let c=r==null?void 0:r[l];if(c||(c=Ts[l]),!c)throw Error(`Invalid item: ${l}`);i.push(c)});const n=i.sort((l,c)=>l[0]-c[0]).map(l=>l[1]);s&&n.push(s);const o=n.join(" | ");return $.verboseRegexp(o,"gm")}static noSplitter(e,r,s){return[e]}static lineSplitter(e,r,s){const i=e.value.split(/\r\n|\r|\n/gm);if(i.length==1)return[e];const n=[];return i.forEach((o,l)=>{if(l){const u=$.createToken("addNewLine","",e.pos,r,s);n.push(u)}const c=0,d=e.pos+c,h=$.createToken(e.key,o,d,r,s);n.push(h)}),n}getRxString(){return this.rxPattern.toString()}addToken(e,r,s){const i=$.createToken(e,r,s,this.settings,this.TokenClass);this.tokens.push(i)}static createToken(e,r,s,i,n){const o=i.mapper[e]||e,l=i.htmlClassPrefix+o,c=r,d=i.PrettifierClass.prettifyToken(e,o,c);return new n(e,r,s,c,d,o,l,i.tokenTypeMapper)}get currentPos(){const e=this.tokens[this.tokens.length-1].pos;return this.posToString(e)}tokenizeString(e){this.rawText=e,this.reset(),this.tokenizedRaw="",this.collectLineInfo();let r;this.rxPattern.lastIndex=0;let s=-1,i=1;for(;r=this.rxPattern.exec(this.rawText);){let n,o;if(!r.groups)throw Error("Use named capturing blocks!");const l=Object.entries(r.groups).filter(([d,h])=>h!=null);if(Object.values(l).reduce((d,h)=>d+h[1].length,0)!==r[0].length)throw Error(`Use named capturing blocks - not captured completely: ${r[0]}`);if(r.index==s)throw Error("Invalid regexp - do not use elements which can return empty values, e.g. (?<value>.*) !");if(r.index!=s+i){const d=e.slice(s+i,r.index);s==-1&&(s=0),this.addToken("_guard",d,s),this.tokenizedRaw+=d}l.forEach(d=>{[n,o]=d,n=n.replace(/__.*$/,""),(!this.settings.skipEmpty||o)&&(this.addToken(n,o,r.index),this.tokenizedRaw+=o)}),s=r.index||0,i=r[0].length||0}if(s+i<e.length){const n=e.slice(s+i);this.addToken("_guard",n,s),this.tokenizedRaw+=n}if(this.tokenizedRaw.length!=e.length)throw Error("Invalid regexp - characters are missing!")}collectLineInfo(){this.linePosTable=[];const e=this.rawText.split(`
`);let r=0,s=0;e.forEach(i=>{s=r+i.length;const n={start:r,end:s};this.linePosTable.push(n),r=s+1})}getLineInfo(e){let r=-1,s=-1;for(;e>r;)s++,r=this.linePosTable[s].end;return[s,this.linePosTable[s--].start]}posToString(e,r="ln %ln col %col",s=1){const[i,n]=this.getLineInfo(e),o=e-n;return r.replace("%ln",(i+s).toString()).replace("%pos",e.toString()).replace("%col",(o+s).toString())}static getNewLines(e){var r;return e.key!=="whiteSpc"?0:((r=e.value.match(/\r\n|\n|\r/g))==null?void 0:r.length)||0}getFormattedFromTokens(e="reprPretty"){const r=this.tokens,s=[""],i=[""],n=[""],o=[""],l=[""];return r.forEach((c,d,h)=>{const[u,x]=this.settings.PrettifierClass.getNewLineCountFunction(c,h,d);x?p(x):u&&this.settings.splitFunc(u,this.settings,this.TokenClass).forEach((w,M)=>{w.key=="addNewLine"?p(1):(w.value!=""||!this.settings.skipEmpty)&&L(w,this)});function p(g){for(let w=0;w<g;w++)s.push(""),i.push(""),n.push(""),o.push(""),l.push("")}function m(g,w,M,A,O){if(w in A){let G=function(oe,W){const bt=M.slice(oe,W);Fe+=bt.length,m(g,"error",bt,A,O)};const N=A[w];if(typeof N=="function"){const[oe,W]=N(w,M);return m(g,oe,W,A,O),g}if(!(N instanceof RegExp))throw Error("Not a regexp value!");let H;N.lastIndex=0;let Fe=0,be=0;for(;H=N.exec(M);){if(!H||!H.groups||!H[0].length||H.index==null)throw Error("Update regexp - empty result!");Object.entries(H.groups).forEach(([oe,W])=>{W&&(Fe+=W.length,m(g,oe,W,A,O))}),H.index!=be&&G(be,H.index),be=H.index+H[0].length}if(be!=M.length&&G(be,M.length),Fe!=M.length)throw Error("Update regexp - characters are missing!");return g}else{const N=O.mapper[w.replace(/__.*$/,"")]||w.replace(/__.*$/,""),H=O.htmlClassPrefix+N;return M.replace(/ /g,String.fromCharCode(160)).split(`
`).forEach((G,oe)=>{if(oe>0&&p(1),G.length>0){const W=`<span class='${H}'>${G}</span>`;s[s.length-1]+=W,i[i.length-1]+=G,n[n.length-1]+=G,o[o.length-1]+=G,l[l.length-1]+=G}}),g}}function L(g,w){u!=null&&m([[]],g.key,g.value,w.subFormatPatterns,w.settings)}}),{allFormattedHTML:s,allTexts:i,allRepr:o,allReprPretty:l,allValues:n}}}const Ee={0:[],1:[b.TTC_COMMAND_TOKENS.BYTE],2:[b.TTC_COMMAND_TOKENS.WORD],3:[b.TTC_COMMAND_TOKENS.F08],4:[b.TTC_COMMAND_TOKENS.F88]};class Ce{constructor(e,r){this.typeCodes=e,this.settings=r}digitToArray(e){const r=parseInt(e);if(r<0||r>9)throw TypeError(`Invalid digit for byte parsing: ${e}`);return[z.textToScreen(e)]}byteToArray(e){const r=parseInt(e);if(r<-128||r>255)throw TypeError(`Invalid value for byte parsing: ${e}`);return[...this.typeCodes[1],r+256&255]}wordToArray(e){const r=parseInt(e);if(r<-32768||r>65535)throw TypeError(`Invalid value for word parsing: ${e}`);const s=r+65536&65535;return[...this.typeCodes[2],s&255,s>>8]}integerToArray(e){return this.settings.integerEncoders.map(s=>{try{return s.bind(this)(e)}catch{return[]}}).filter(s=>s.length>0)[0]}}const pt={allowDigits:!0,allowTokens:!0,integerEncoders:[Ce.prototype.digitToArray,Ce.prototype.byteToArray,Ce.prototype.wordToArray]},Cs=254;class Se extends Error{constructor(e,r){const s=`Invalid variable name: ${e}. ${r}`;super(s),this.name="InvalidVariableNameError",Object.setPrototypeOf(this,new.target.prototype)}}function Rs(t){return t.sort((s,i)=>Te[s]-Te[i]).reduce((s,i)=>{if(s.length===0)return[[i]];const n=s[s.length-1],o=n[n.length-1];return Te[i]===Te[o]+1?n.push(i):s.push([i]),s},[]).map(s=>s.length>2?`${s[0]}-${s[s.length-1]}`:s.join("")).join("")}class ks{constructor(){this.rxTypesLong=Object.keys(it).join("|"),this.rxTypesShort=Object.keys(nt).join("").replace(/0/,""),this.defaultSizePostfix={128:"$",254:""},this.numberTokenizer=new Ce(Ee,pt),this.variableMapping={}}getDimText(e){let r="";return e.forEach(s=>{s.category==="dimDetailsLong"&&(r+=s.value+`
`)}),r}getType(e){const r={dataLength:1,memBytes:1},s=/^(?<baseType>\$|FIXSTR|.*)[.]?(?<dataLength>\d+)?$/,i=e.match(s);let n=1;if(!(i!=null&&i.groups))throw new Error(`Invalid type string format: ${e}`);(i.groups.baseType==="$"||i.groups.baseType==="FIXSTR")&&(i!=null&&i.groups.dataLength?n=Number(i.groups.dataLength):n=Cs,r.dataLength=n,r.memBytes=n+2);const o=i.groups.baseType;if(o in nt)return{...nt[o],...r};if(o.toUpperCase()in it)return{...it[o.toUpperCase()],...r};throw new Error(`Invalid type string format: ${e}`)}parseDimShort(e){throw Error("Not implemented dim short parse!")}parseDimLong(e,r){const s=$.verboseRegexp(String.raw`
            (?<wspc3>^\s*)(?<type>
                ${this.rxTypesLong} |
                ([$]\d+) |
                [${this.rxTypesShort}]
            )
            (?<arr_sign>(<[=-]{1,2}))?
            (?<arr_size>\d*)
            (?=$|\s+) |
            (
                (?<var_name>
                    [a-zA-Z][a-zA-Z_×]*
                )
                (?<wspc1>\s*[,;]?\s*)
                (
                    (?<comment>[-|\/]{2}.*?$) |
                    (?<break>,|$)
                )
            ) |
            (?<wspc2>[\t\x20]+\n?|\n) |

            (?<error_word>\w+) |
            (?<error>.)`,"gmi");s.lastIndex=0;let i,n=0,o=0;const l=[],c={};let d=null,h=0,u=null,x=0;for(;i=s.exec(e);){if(!i||!i.groups||!i[0].length||i.index==null)throw Error("Update regexp - empty result!");Object.entries(i.groups).forEach(([p,m])=>{if(m){if(n+=m.length,p==="type"&&(d=this.getType(m),h=0),p==="arr_size"&&(h=parseInt(m,10)),p==="var_name"){this.assertVarNameValid(m,r,!0),u=m;const L=u.replace(/×/g,"x"),g=Te[L]||x+100;c[u]={type:d,arr_size:h,comment:"",idx:x,idxScore:g},x++}p==="comment"&&u&&(c[u].comment=m.replace(/^--\s*/g,"")||""),p==="error"&&l.push([o,i==null?void 0:i.index,m]),p==="error_word"&&l.push([o,i==null?void 0:i.index,`Invalid word: ${m}`])}}),i.index!=o&&l.push([o,i.index,i[0]]),o=i.index+i[0].length,n!=o&&l.push([o,i==null?void 0:i.index,e.substring(o,i==null?void 0:i.index)])}if(o!=e.length&&l.push([o,0]),n!=e.length)throw Error("Update regexp - characters are missing!");return this.variableMapping=c,{vars:c,errors:l}}getVariableMapping(){return this.variableMapping}assertVarNameValid(e,r,s){const i=/^[a-zA-Z]×?$/.test(e),n=/^[a-zA-Z][a-zA-Z_]{1,}$/.test(e);if(!s&&!i)throw new Se(e,"Only a single letter or a letter with × is allowed.");if(e in We)throw new Se(e,"Variable name cannot be a keyword.");if(s&&!r&&i)throw new Se(e,"No single letter variable names are allowed. Use #directshort directive to allow them.");if(s&&n||s&&r&&i||!s&&i)return;throw new Se(e,"Invalid variable name, ony a-z,A-Z, A×-Z×, _ are allowed.")}assignVariableNames(e){const r=Object.entries(e).sort((n,o)=>n[1].idxScore-o[1].idxScore),s=[...Object.keys(Te)],i={};return r.forEach(([n,o])=>{const l=o.idxScore<100;let c=n;if(l){const d=s.indexOf(n);if(d!==-1)s.splice(d,1);else throw new Se(n,"Short variable name not found in possible variables.")}else if(c=s.shift()||"",!c)throw new Se(n,"No more short variable names available.");i[c]={...o,varName:n,transformedVarName:c,isShortVar:l}}),i}encodeDimLong(e){const r=[],i={};Object.values(e).forEach(l=>{const{type:c,arr_size:d}=l,{encodedType:h,encodedTypeBytes:u}=this.getTypeCode(c,d);l.typeCode=h,l.encodedTypeBytes=u;const x=h;i[x]=i[x]||[],i[x].push(l)});const n=Object.values(e).sort((l,c)=>l.idx-c.idx).map(l=>l.typeCode).filter((l,c,d)=>d.indexOf(l)===c),o={};return Object.entries(i).forEach(([l,c])=>{if(l===null)return;const d=[];if(c[0].type==null)return;d.push(...c[0].encodedTypeBytes),o[l]=d;const h=c.map(p=>p.transformedVarName),u=Rs(h),x=Y.convertStringToBytes(u,ht).byteArray;d.push(...x)}),n.forEach(l=>{const c=o[l];r.push(...c,Z[","])}),r.pop(),r}getTypeCode(e,r){let s="";const i=[];if(e.shortCode!="$")s+=e.shortCode,i.push(Z[e.shortCode]);else if(Object.keys(this.defaultSizePostfix).includes(e.dataLength.toString(10))){const n=this.defaultSizePostfix[e.dataLength];s+=`$${n}`,i.push(Z.$,...Y.convertStringToBytes(n,ht).byteArray)}else s+=`$${e.dataLength}`,i.push(Z.$,...this.numberTokenizer.integerToArray(e.dataLength.toString(10)));return r>0&&(s+=`{'<=='}${r.toString()}}`,e.shortCode=="$"&&i.push(Z["<=="]),i.push(...this.numberTokenizer.integerToArray(r.toString(10)))),{encodedType:s,encodedTypeBytes:i}}}class ee{constructor(e=0){this._value=0,this._value=e}isTrue(){return this._value===1||this._value===3}isFalse(){return this._value===2||this._value===4}isFinal(){return this._value===3||this._value===4}set value(e){this.isFinal()||(e===!0?this._value=1:e===!1?this._value=2:this._value=e)}}class Ft{constructor(e){this.text=e,this.directives={},this.directiveValues=[],this.directiveFunctions={}}process(){this.readGlobalDirectiveValues()}readGlobalDirectiveValues(){const e=/(?:^[\n\s]*)((#\S*\s*)+)/m,r=this.text.match(e);if(!r)return{result:[],error:null};const s=r[1].split(/\s+/).map(n=>n.trim().replace(/#/g,"")).filter(n=>n.length>0),i=[];return s.forEach(n=>{Object.keys(this.directives).indexOf(n)===-1&&i.push(n)}),i.length>0?{result:[],error:`Invalid directive(s): ${i.join(", ")}`}:{result:s,error:null}}useGlobalDirectives(){const e=this.readGlobalDirectiveValues();if(e.error)throw new Error(e.error);this.directiveValues=e.result,this.directiveValues.forEach(r=>{this.directiveFunctions[r]()})}getFinalDirectives(){const e={};return Object.entries(this.directives).forEach(([r,s])=>{s instanceof ee&&(s=s.isTrue()),e[r]=s}),e}}class Bt extends Ft{constructor(){super(...arguments),this.directives={verbose:new ee(1),compact:new ee(2),strict:new ee(1),loose:new ee(2),inline:new ee(2),safe:new ee(1),trusted:new ee(2),directshort:new ee(2)},this.directiveFunctions={verbose:()=>{this.directives.verbose.value=!0,this.directives.compact.value=!1},compact:()=>{this.directives.verbose.value=!1,this.directives.compact.value=!0},strict:()=>{this.directives.strict.value=!0,this.directives.loose.value=!1},loose:()=>{this.directives.strict.value=!1,this.directives.loose.value=!0},inline:()=>{this.directives.inline.value=!0},safe:()=>{this.directives.safe.value=!0,this.directives.trusted.value=!1},trusted:()=>{this.directives.safe.value=!1,this.directives.trusted.value=!0},directshort:()=>{this.directives.directshort.value=!0}}}setSettings(e){e.verboseMode===1?(this.directives.verbose.value=3,this.directives.compact.value=4):e.verboseMode===2?(this.directives.verbose.value=4,this.directives.compact.value=3):e.verboseMode===0&&(this.directives.verbose.value=!0,this.directives.compact.value=!1)}analyzeVarsFromTokenized(e){const r={};return e.forEach(s=>{s.category==="VAR"&&(r[s.value]=(r[s.value]||0)+1)}),r}getDimDetails(e){var i,n,o;let r=0,s=e.findIndex(l=>l.category==="DIM");if(s===-1)return{memSettings:r};for(((i=e[s+1])==null?void 0:i.category)=="intNum"&&(r=e[s+1].value,s+=2);s<e.length&&!(e[s].category==="commandSep"&&e[s].value===";");){if(e[s].category==="idType"){for(e[s].value,((n=e[s+1])==null?void 0:n.category)==="intNum"&&(e[s+1].value,s++),s++;((o=e[s])==null?void 0:o.category)==="VAR";)e[s].value,e[s].value;s++}s++}}}class mt{static prettifyToken(e,r,s){return""}static getIndentOffset(e,r){return[0,0]}static getNewLineCountFunction(e,r,s){return[e,0]}}class ws extends mt{static prettifyToken(e,r,s){return s}static getIndentOffset(e,r){return[0,0]}static getNewLineCountFunction(e,r,s){var i;return e.key!=="whiteSpc"?[e,0]:[null,((i=e.value.match(/\r\n|\n|\r/g))==null?void 0:i.length)||0]}}class Le{constructor(e,r,s,i,n,o,l,c=null){this.key=e,this.value=r,this.pos=s,this.repr=i,this.reprPretty=n,this.category=o,this.spanClass=l,this.typeMapper=c||Le.defaultMapper}isRemark(){return this.typeMapper.remark.indexOf(this.key)>=0}isNumber(){return this.typeMapper.number.indexOf(this.key)>=0}isString(){return this.typeMapper.string.indexOf(this.key)>=0}isUnaryOperation(){return this.typeMapper.unaryOp.indexOf(this.value)>=0}isBinaryOperation(){return this.typeMapper.binaryOp.indexOf(this.value)>=0}isAssignment(){return this.typeMapper.assignment.indexOf(this.value)>=0}isType(e){return this.typeMapper[e].indexOf(this.key)>=0||this.typeMapper[e].indexOf(this.value)>=0}}Le.defaultMapper={remark:["remark","rem_multi","docstr"],number:["hexNum","floatNum","intNum"],string:["strDQuote","strSQuote","strBQuote"],binaryOp:["+","-","<","<=","==",">",">=","!=","!==","===","||","&&","*","/","%","|","&"],unaryOp:["(","-","~"],assignment:["=","|=","&=","+=","-=","*=","/=","^="]};class Vt{constructor(e){Object.keys(e).forEach(r=>{if(["rxPattern","subFormatPatterns","skipEmpty","mapper","PrettifierClass","TokenClass","splitFunc","getNewLineCountFunction","tokenTypeMapper","htmlClassPrefix"].indexOf(r)==-1)throw Error(`Invalid key ${r} for tokenizer settings!`)}),this.rxPattern=e.rxPattern||/(?<symbol>.)/g,this.subFormatPatterns=e.subFormatPatterns||{},this.skipEmpty=e.skipEmpty===void 0?!0:e.skipEmpty,this.mapper=e.mapper||{},this.htmlClassPrefix=e.htmlClassPrefix||"",this.splitFunc=e.splitFunc||$.noSplitter,this.tokenTypeMapper=e.tokenTypeMapper||Le.defaultMapper,this.TokenClass=e.TokenClass||Le,this.PrettifierClass=e.PrettifierClass||ws,this.getNewLineCountFunction=e.getNewLineCountFunction||null}}class De extends mt{static prettifyToken(e,r,s){return e!=="func"&&e!=="command"&&e!=="other"?s:e=="command"?s+" ":De.PRETTIFY_REPL[s]||s}static getIndentOffset(e,r){return[0,0]}static getNewLineCountFunction(e,r,s){var i;return e.key!=="newLines"?[e,0]:[null,((i=e.value.match(/\r\n|\n|\r/g))==null?void 0:i.length)||0]}}De.PRETTIFY_REPL={"=":" = ","+":" + ","-":" - ","*":" * ","/":" / ",",":", ",to:" to ",step:" step ",and:" and ",or:" or ",fn:"fn ",then:" then "};const zt=(t,e)=>e.length-t.length,As=Object.keys(_s).sort(zt).join("|"),vs=Object.entries(ms).map(([t,e])=>{const[r,s]=e;return s&ge.FN_WITH_BRACKET?String.raw`${t}\(`:t}).sort(zt).join("|");class qe extends ${constructor(e={}){const r={1:{gbIdentifier:"gbIdentifierLong",gbDim:"gbDimLong"},2:{gbIdentifier:"gbIdentifierShort",gbDim:"gbDimShort"},0:{}};let s=e.verboseMode||0;s===0&&(s=1);const i={gbIdentifierLong:[8e3,String.raw`(?<identifier>[\w×]+)`],gbIdentifierShort:[8e3,String.raw`(?<identifier>[\w][×]?)`],gbSysVar:[8100,String.raw`(?<sysId>[@][\w×]+)`],gbPostfix:[8200,String.raw`(?<postfix>\.[\w×]+)`],gbLabel:[4e3,String.raw`(?<label>^[\w]+\s*[:]$)`],gbDimLong:[6e3,String.raw`(?<command__dim>dim)(?<dimDetailsLong>[^;]*)(?<whiteSpc__dim>;)`],gbDimShort:[6e3,String.raw`(?<command__dim>dim)(?<dimDetailsShort>[^;]*)(?<whiteSpc__dim>;)`],gbCommand:[6050,String.raw`(?<command>\?|${As})(?![a-zA-Z_])`],gbFunction:[6100,String.raw`(?<func>${vs})(?![a-zA-Z_])`],gbOperator:[6200,String.raw`(?<operator>(AND|OR|div|mod|xor|and|or)(?![a-zA-Z_])|[+\-*\/^>=<&])`],v2Sep:[7e3,String.raw`(?<commandSep>[:])`],newLines:[3050,String.raw`(?<newLines>(\r\n|\n|\r)+)`],whiteSpace:[3100,String.raw`(?<whiteSpc>[\t\ \xA0]+)`],gbTypes:[6300,String.raw`(?<idType>([us]?(byte|word|f08|f88|f2416|float))|char|dchar|varstr|fixstr|[$])`],gbRemDash:[1150,String.raw`(?<remarkDash>[\-]{2}.*$)`],gbSysBlock:[1e3,String.raw`(?<sysBlock>[#]start.*?[#]end\s*)`],gbSysCmd:[1200,String.raw`(?<sysCmd__const>[#]const[^;]+?[;])`],gbSysUse:[1200,String.raw`(?<use>^\s*[#]use\s+[\w=,]+)`],gbSysCmdOther:[1250,String.raw`(?<sysCmd__other>[#].*$)`],gbExpr:[6300,String.raw`(?<expr>[{][^}]*?[}])`],gbOther:[8500,String.raw`(?<other__8500>[@,;\(\)\[\]])`],gbStrQQuote:[2050,String.raw`(?<other_quote__strQO>\"\")(?<strQQuote>(?:[{][^}]*?[}]|.)*?)(?<other_quote__strQC>\"\")`],gbStrDQuote:[2100,String.raw`(?<other_quote__strDO>\")(?<strDQuote>(?:[{][^}]*?[}]|[^\"])*?)(?<other_quote__strDC>\")`],gbStrSQuote:[2200,String.raw`(?<other_quote__strSO>\')(?<strSQuote>(?:[{][^}]*?[}]|[^\'])*?)(?<other_quote__strSC>\')`],gbStrBQuote:[2300,String.raw`(?<other_quote__strBO>\`)(?<strBQuote>(?:[{][^}]*?[}]|[^\`])*?)(?<other_quote__strBC>\`)`]},n=$.buildRxString([j.remark,j.docstr,j.remMulti,j.numInt,j.numFloat,"gbSysCmdOther","gbSysCmd","gbSysBlock","gbSysUse","gbStrQQuote","gbStrDQuote","gbStrSQuote","gbStrBQuote","gbExpr","gbOther","gbRemDash","gbSysVar",r[s].gbIdentifier,"gbPostfix","gbLabel","gbOperator","gbTypes",r[s].gbDim,"gbCommand","gbFunction","newLines","v2Sep","whiteSpace"],i,""),o={strDQuote:String.raw`  (
                                      (?<other__sp_open>[{])
                                      (?<strSpecial>[^}]*?)
                                      (?<other__sp_close>[}])
                                    ) |
                                    (?<strNormal>[^{]+)`,strSpecial:String.raw`
            (?<whiteSpc__100>\s*?)(
             (?<remark__str>(([-]{2}|[/]{2}).*$)|[/][*][\s\S]*?[*][/]) |

             ( (?<func__str>\w+\s*)
                (?<other__bropen>[(])
                (?<strfunc_params>[^)]*?)
               (?<other__brclose>[)])
             ) |

             (
               (?<strSpecCheck>\w+) |
               (?<intNum__1>[a-zA-Z_][a-zA-Z_0-9]*) |
               (?<intNum__2>(?:[$]|0x)[0-9a-fA-F]+[w]{0,1}) |
               (?<intNum__3>[0-9]+[w]{0,1})
             )
             ((?<other__multi>\s*[*]\s*)(?<intNum__str>[0-9]+))?
             (?<other__100>[,;]\s*|\s+|\s*$)
           ) |
           (?<other__101>\s+) |
           (?<error>.+?)
           `,strSpecCheck:qe.validateCode,strfunc_params:String.raw`
                            (?<other__spec100>\")(?<strNormal__strspec>[^\"]*?)(?<other__spec150>\") |
                            (?<intNum__spec100>\d+) |
                            (?<other__spec200>[,]) |
                            (?<other__spec300>.)
                            `,dimDetailsShort:"__main"},l={command:"CMD",commandRem:"CMD",func:"FUNC",error:"ERR",strDQuote:"STR",strQQuote:"STR",strSQuote:"STR",strBQuote:"STR",strNormal:"STR",strSpec:"SPEC",label:"LABEL",floatNum:"NUM",intNum:"NUM",identifier:"VAR",identifier2:"VAR",idExtra:"EXTRA",idType:"FUNC",sysId:"FUNC",commandSep:"SEP",whiteSpc:"SPC",remark:"REM",remarkDash:"REM",rem_multi:"REM",docstr:"DOCSTR",other:"OTHER",other_quote:"SKIP",sysCmd:"SYS",sysCmd2:"SYS",postfix:"FUNC"},c=new Vt({rxPattern:n,subFormatPatterns:o,mapper:l,htmlClassPrefix:"editor-style-",PrettifierClass:De});super(c)}static validateCode(e,r){return r.toUpperCase()in b.TTC_STRING_TOKENS_UPPER?["strSpec",r]:["error",r]}getTokensFromMemory(e){const r=Ae.getTokensFromMemory(e);this.reset(),r.forEach(s=>{this.addToken(s.key,String(s.value),s.pos)})}tokenizeStr(e){this.tokenizeString(e)}}class At{constructor(e,r){this.typeCodes=e,this.settings=r,this.subTokenized=[],this.varMappings={},this.validChars=[],this.reset()}reset(){this.subTokenized=[],this.varMappings={};const e=[],r=[],s=[];for(let i=0;i<26;i++)e.push(at[i+1]),r.push(at[i+65]),s.push(at[i+65]+"×");this.validChars.push(...e,...r,...s)}subTokenize(e,r=!1){var o,l,c,d,h,u,x,p;let s=/(?<postindex>\.\d+|<-\d+)|(?<quickindex><-\w+)|(?<postfix>\.\w+)|(?<base>[a-z_A-Z×]+)/gm;r||(s=/(?<postindex>\.\d+|<-\d+)|(?<quickindex><-\w+)|(?<postfix>\.\w+)|(?<base>[a-zA-Z][×]?)(?<postfix2>[\w×]*)/gm),s.lastIndex=0;let i=null;const n=[];for(;(i=s.exec(e))!==null;){i.index===s.lastIndex&&s.lastIndex++;const m=((o=i.groups)==null?void 0:o.base)||"",L=((l=i.groups)==null?void 0:l.postfix)||"",g=((c=i.groups)==null?void 0:c.postindex)||"",w=((d=i.groups)==null?void 0:d.quickindex)||"",M=!r||m.length==1||m.length==2&&m[1]=="×";if(m){const A=M?m:this.longvarToShortvar(m);if(n.push(Z[A]),(h=i.groups)!=null&&h.postfix2){let O=0;for(;O<((u=i.groups)==null?void 0:u.postfix2.length);){let N=(x=i.groups)==null?void 0:x.postfix2[O];((p=i.groups)==null?void 0:p.postfix2[O+1])=="×"&&(N+="×",O++),N&&n.push(Z[N]),O++}}}if(L){const A=gs[L.replace(/\./g,"")][0];n.push(Z[A])}else if(g){const A=g.replace(/<-|\./g,""),N=new Ce(Ee,pt).integerToArray(A);n.push(...N)}else if(w){const A=w.replace(/<-|\./g,""),O=M?A:this.longvarToShortvar(A);n.push(Z["<--"]),n.push(Z[O])}}return n}longvarToShortvar(e){if(this.settings.isStrict&&e.length>0&&this.settings.dimObject[e]===void 0)throw new Error(`Variable ${e} not found in DIM declaration`);const r=this.getNextShortVar();if(!r)throw new Error("No more short variable names available");const s=this.varMappings[r];if(s){if(s.longvar!==e)throw new Error(`Short variable ${r} already defined as ${s.longvar}`);return r}return this.varMappings[r]={shortvar:r,longvar:e,isArray:!1,length:0},r}getNextShortVar(){return this.validChars.shift()||""}}const vt={isStrict:!1,dimObject:{}},ht={tokens:b.TTC_STRING_TOKENS,normalConverter:z.textToScreen,funcs:b.gbFuncs};let V=class Oe extends me{constructor(e={}){super(),this.varTokenizer=new At(Ee,vt)}static numEncoder(e,r){if(e.key=="intNum")return new Ce(Ee,pt).integerToArray(e.value);throw TypeError(`Invalid type for ${e.key}: ${e.value}`)}static dimEncoder(e,r){const s=new ks,i=e.value,{vars:n,errors:o}=s.parseDimLong(i,!0),l=s.assignVariableNames(n);return s.encodeDimLong(l)}static stringEncoder(e,r){if(e.key=="other"&&e.value=="?")return[b.TTC_COMMAND_TOKENS.print];const s=[],{byteArray:i,status:n,_invalidCodes:o}=Y.convertStringToBytes(e.repr,ht);if(n!=="OK"&&console.log(n),["strDQuote","strSQuote","strBQuote","strQQuote"].includes(e.key)){const l=b[e.key];s.push(l),s.push(i.length)}return s.concat(i)}static otherEncoder(e,r){return r.lastCommand=="clr"&&e.repr==","?[]:Oe.stringEncoder(e,r)}static varEncoder(e,r){return r.varTokenizer.subTokenize(e.repr,r.isVerbose)}static cmdEncoder(e,r){const s=e.repr.replace("(",""),i=b.TTC_COMMAND_TOKENS[s],n=b.EXTRA_ZEROS[s];return n>0?[i,...Array(n).fill(0)]:(b.IS_COMMAND[s]&&(r.lastCommand=s),[i])}static encodeTextAsBytes(e,r={}){const s=new Bt(e);s.setSettings(r),s.useGlobalDirectives();const i=new qe(r);i.tokenizeString(e),s.analyzeVarsFromTokenized(i.tokens);const n=s.getFinalDirectives();return Oe.encodeTokens(i.tokens,n)}static encodeTokens(e,r){const s=[],i={nextAddr:0,line:null,data:[]};function n(){if(i.data.length>0){const c=Object.assign({},i);s.push(c),i.data=[]}}const o={isVerbose:r.verbose,varTokenizer:new At(Ee,vt),lastCommand:""};e.forEach(c=>{if(c.category=="LABEL"){n(),parseInt(c.value,10);return}const d=Oe.encoders[c.key]||Oe.encoders[c.category];if(d){const h=d(c,o);i.data.push(...h)}else throw Error(`Encoder needed for ${c.key}, ${c.category} for value ${c.value}!`)}),n();const l=[];return s.forEach(c=>{l.push(...c.data,b.blockEndToken)}),l.push(b.finalToken),l}};V.encoders={idType:V.stringEncoder,postfix:V.varEncoder,STR:V.stringEncoder,NUM:V.numEncoder,VAR:V.varEncoder,SEP:V.stringEncoder,CMD:V.cmdEncoder,FUNC:V.cmdEncoder,operator:V.cmdEncoder,OTHER:V.otherEncoder,commandSep:me.voidEncoder,SKIP:me.voidEncoder,whiteSpc:me.voidEncoder,sysCmd:me.voidEncoder,newLines:me.voidEncoder,dimDetailsLong:V.dimEncoder};class $t{constructor(e){this.settings=e,this.tokens=[],this.activeTokenId=0,this.token={},this.nextToken={},this.scope="",this.docStr={},this.params={},this.tags=[],this.labels={},this.functions={}}parseTokens(e){this.tokens=e,this.activeTokenId=0,this.token={key:"_whsp"},this.params={vars:{}},this.docStr={},this.scope="__global",this.tags=[],this.labels={},this.functions={}}isFinished(){return this.activeTokenId>=this.tokens.length}posToString(){return this.settings.posToStringFn(this.token.pos)}startTag(e,r){const s="   ".repeat(this.tags.length);this.tags.push(e),console.log(`${s}<${e}> ${r}`)}endTag(){const e=this.tags.pop(),r="   ".repeat(this.tags.length);console.log(`${r}</${e}>`)}advance(){if(this.isFinished())throw Error("Document finished unexpectedly!");do{this.token=this.tokens[this.activeTokenId],this.activeTokenId++,this.token.key==this.settings.keys._docstr&&(this.docStr[this.scope]=(this.docStr[this.scope]||"")+this.token.value);const e=this.activeTokenId;do this.nextToken=this.tokens[this.activeTokenId],this.activeTokenId++;while((this.nextToken.key==this.settings.keys._whsp||this.nextToken.isRemark())&&!this.isFinished());if(this.activeTokenId=e,this.nextToken==null)break}while((this.token.key==this.settings.keys._whsp||this.token.isRemark())&&!this.isFinished())}unexpectedToken(e){throw Error(`Unexpected token '${this.token.value}' at ${this.posToString()}. 
Expected: ${e}.`)}eatGivenType(e){this.advance(),this.token.key!==e&&this.unexpectedToken(e)}eatIdentifier(){return this.eatGivenType("identifier"),this.token}eatValue(e){this.advance(),this.token.value!==e&&this.unexpectedToken(e)}eatAnyOfList(e){this.advance(),e.indexOf(this.token.value)==-1&&e.indexOf(this.token.key)==-1&&this.unexpectedToken(e.toString())}eatMany(e){const r={},s=/([{]{2}(?<inputType>\w+)\s+(?<inputName>\w+)[}]{2})|(?<const>\S+)|(?<whitespace>\s+)/gm;let i=null;for(;(i=s.exec(e))!==null;)if(i.groups!==void 0&&(i.groups.const!==void 0?this.eatValue(i.groups.const):i.groups.inputType!==void 0&&(this.eatGivenType(i.groups.inputType),r[i.groups.inputName]=this.token),this.isFinished()))throw Error(`Unfinished expression, expected ${e}`);return r}parseVarDeclaration(){const e=this.eatIdentifier().value;this.eatValue(":");const r=this.eatIdentifier().value;this.params.vars[e]=r}parseClassConst(){this.parseConst()}parseParams(){let e="",r="";const s={};for(;this.eatAnyOfList(["identifier",")"]),!(this.token.value==")"||(e=this.token.value,r="any",this.eatAnyOfList([":",",",")"]),this.token.value==":"&&(r=this.eatIdentifier().value,this.eatAnyOfList([",",")"])),s[e]=r,this.token.value==")")););return s}parseExpression(){for(this.startTag("expression","");;){if(this.advance(),this.token.isUnaryOperation()&&this.advance(),!this.token.isNumber()){if(!this.token.isString())break}this.nextToken.isBinaryOperation()&&this.advance()}this.endTag()}parseDict(){for(this.eatValue("{");this.token.value!="}";)this.advance()}parseList(){this.eatValue("[");let e=1;for(;e!=0;)this.advance(),this.token.value=="["&&e++,this.token.value=="]"&&e--}parseConst(){const e=this.eatIdentifier().value;this.eatValue("="),this.startTag("const",e),this.nextToken.value=="{"?this.parseDict():this.nextToken.value=="["?this.parseList():this.parseExpression(),this.endTag()}parseBlock(){for(this.startTag("block","");;){const e=this.activeTokenId;if(this.advance(),this.token.value=="}"){this.activeTokenId=e;break}if(this.token.key=="keyword")switch(this.token.value){case"const":this.parseConst()}}this.endTag()}parseMethod(){const e=this.eatIdentifier().value;this.startTag("method",e),this.params.method=e,this.eatValue("("),this.parseParams(),this.eatValue("{"),this.parseBlock(),this.eatValue("}"),this.endTag()}parseMethods(){for(;this.parseMethod(),this.nextToken.value!="}";);}parseClass(){const r=this.eatMany("class {{identifier classname}} extends GolfClass {").classname.value;for(this.params.class=r,this.startTag("class",r);;){const s=this.activeTokenId;if(this.advance(),this.activeTokenId=s,this.token.value=="}")break;switch(this.nextToken.value){case":":this.parseVarDeclaration();break;case"=":this.parseClassConst();break;case"(":this.parseMethod();break}}this.eatValue("}"),this.endTag()}}class Pe{constructor(e){this.posToStringFn=e.posToStringFn||String,this.keys=e.keys||Pe.defaultKeys}}Pe.defaultKeys={_whsp:"whiteSpc",_docstr:"docstr"};class Ms extends $t{constructor(){const e=new Pe({});super(e)}}const Mt={Tokenizer:qe,Prettifier:De,Parser:Ms,Encoder:V,Decoder:Ae,Preprocessor:Bt};class F{}F.BASIC_TOKENS={128:"end",129:"for",130:"next",131:"data",132:"input#",133:"input",134:"dim",135:"read",136:"let",137:"goto",138:"run",139:"if",140:"restore",141:"gosub",142:"return",143:"rem",144:"stop",145:"on",146:"wait",147:"load",148:"save",149:"verify",150:"def",151:"poke",152:"print#",153:"print",154:"cont",155:"list",156:"clr",157:"cmd",158:"sys",159:"open",160:"close",161:"get",162:"new",163:"tab(",164:"to",165:"fn",166:"spc(",167:"then",168:"not",169:"step",170:"+",171:"-",172:"*",173:"/",174:"^",175:"and",176:"or",177:">",178:"=",179:"<",180:"sgn",181:"int",182:"abs",183:"usr",184:"fre",185:"pos",186:"sqr",187:"rnd",188:"log",189:"exp",190:"cos",191:"sin",192:"tan",193:"atn",194:"peek",195:"len",196:"str$",197:"val",198:"asc",199:"chr$",200:"left$",201:"right$",202:"mid$",203:"go",255:"pi"};F.SCREEN_COMMANDS={0:"null",1:"ct_a",2:"ct_b",3:"ct_c",4:"ct_d",5:"white",6:"ct_f",7:"ct_g",8:"ct_h",9:"ct_i",10:"ct_j",11:"ct_k",12:"ct_l",13:"return",14:"ct_n",15:"ct_o",16:"ct_p",17:"down",18:"reverse_on",19:"home",20:"delete",21:"ct_u",22:"ct_v",23:"ct_w",24:"ct_x",25:"ct_y",26:"ct_z",28:"red",29:"right",30:"green",31:"blue",32:"space",92:"pound",95:"arrow_left",129:"orange",133:"f1",134:"f3",135:"f5",136:"f7",137:"f2",138:"f4",139:"f6",140:"f8",144:"black",145:"up",146:"reverse_off",147:"clear",149:"brown",150:"pink",151:"dark_gray",152:"gray",153:"light_green",154:"light_blue",155:"light_gray",156:"purple",157:"left",158:"yellow",159:"cyan",160:"sh_space",161:"cm_k",162:"cm_i",163:"cm_t",164:"cm_@",165:"cm_g",166:"cm_+",167:"cm_m",168:"cm_pound",169:"sh_pound",170:"cm_n",171:"cm_q",172:"cm_d",173:"cm_z",174:"cm_s",175:"cm_p",176:"cm_a",177:"cm_e",178:"cm_r",179:"cm_w",180:"cm_h",181:"cm_j",182:"cm_l",183:"cm_y",184:"cm_u",185:"cm_o",186:"sh_@",187:"cm_f",188:"cm_c",189:"cm_x",190:"cm_v",191:"cm_b",192:"sh_asterisk",219:"sh_+",220:"cm_-",221:"sh_-",223:"cm_asterisk",255:"pi"};F.CTT_COMMAND_TOKENS=F.BASIC_TOKENS;F.TTC_COMMAND_TOKENS={end:128,for:129,next:130,data:131,"input#":132,input:133,dim:134,read:135,let:136,goto:137,run:138,if:139,restore:140,gosub:141,return:142,rem:143,stop:144,on:145,wait:146,load:147,save:148,verify:149,def:150,poke:151,"print#":152,print:153,cont:154,list:155,clr:156,cmd:157,sys:158,open:159,close:160,get:161,new:162,"tab(":163,to:164,fn:165,"spc(":166,then:167,not:168,step:169,"+":170,"-":171,"*":172,"/":173,"^":174,and:175,or:176,">":177,"=":178,"<":179,sgn:180,int:181,abs:182,usr:183,fre:184,pos:185,sqr:186,rnd:187,log:188,exp:189,cos:190,sin:191,tan:192,atn:193,peek:194,len:195,str$:196,val:197,asc:198,chr$:199,left$:200,right$:201,mid$:202,go:203,pi:255};F.CTT_SCREEN_TOKENS=F.SCREEN_COMMANDS;F.TTC_SCREEN_TOKENS={null:0,ct_a:1,ct_b:2,ct_c:3,ct_d:4,white:5,ct_f:6,ct_g:7,ct_h:8,ct_i:9,ct_j:10,ct_k:11,ct_l:12,return:13,ct_n:14,ct_o:15,ct_p:16,down:17,reverse_on:18,home:19,delete:20,ct_u:21,ct_v:22,ct_w:23,ct_x:24,ct_y:25,ct_z:26,red:28,right:29,green:30,blue:31,space:32,pound:92,arrow_left:95,orange:129,f1:133,f3:134,f5:135,f7:136,f2:137,f4:138,f6:139,f8:140,black:144,up:145,reverse_off:146,clear:147,brown:149,pink:150,dark_gray:151,gray:152,light_green:153,light_blue:154,light_gray:155,purple:156,left:157,yellow:158,cyan:159,sh_space:160,cm_k:161,cm_i:162,cm_t:163,"cm_@":164,cm_g:165,"cm_+":166,cm_m:167,cm_pound:168,sh_pound:169,cm_n:170,cm_q:171,cm_d:172,cm_z:173,cm_s:174,cm_p:175,cm_a:176,cm_e:177,cm_r:178,cm_w:179,cm_h:180,cm_j:181,cm_l:182,cm_y:183,cm_u:184,cm_o:185,"sh_@":186,cm_f:187,cm_c:188,cm_x:189,cm_v:190,cm_b:191,sh_asterisk:192,"sh_+":219,"cm_-":220,"sh_-":221,cm_asterisk:223,pi:255};F.TTC_STRING_TOKENS=F.TTC_SCREEN_TOKENS;class Ht{static getTokensFromMemory(e,r=2049){const s=function(l,c){return l+c*256},i=[];let n=0,o=r;for(;n<e.length;){let u=function(x){if(h>=128){const p=F.CTT_COMMAND_TOKENS[h];if(!p)return;x.key=h>162?"func":"command",x.value=p}h>=65&&h<=90&&(x.key="identifier",x.value=x.escapedValue),h==32&&(x.key="whiteSpc",x.value=x.escapedValue)};if(o<n+r||o<r||o>r+e.length){console.log(`Invalid address ${o}`);break}if(n=o-r,o=s(e[n],e[n+1]),o==0)break;const l=s(e[n+2],e[n+3]);i.push({key:"label",value:l.toString(10),pos:n+r}),n+=4;let c;c=1;const d={key:"error",value:"error",escapedMode:"",escapedValue:""};let h=0;for(;n+r<o&&(h=e[n],h!=0);){switch(d.value="error",d.key="error",[d.escapedMode,d.escapedValue]=z.petsciiCodeToEscaped(h),c){case 1:u(d),c=3,d.value=="rem"&&(c=2);break;case 2:d.key="rem",d.value=d.escapedValue;break;case 0:d.escapedValue=='"'?(c=3,d.key="other"):d.key="strDQuote",d.escapedMode=="code"?d.value=F.CTT_SCREEN_TOKENS[h]?`{${F.CTT_SCREEN_TOKENS[h]}}`:`{${d.escapedValue}}`:d.value=d.escapedValue;break;case 3:d.value=d.escapedValue,d.key="other",u(d),d.value=='"'?c=0:d.value==":"?c=1:(d.value>="0"&&d.value<="9"||d.value==".")&&(d.key="floatNum");break}i.push({key:d.key,value:d.value,pos:n+r}),n++}i.push({key:"newLines",value:`
`,pos:n+r})}return i}static tokenArrayToRepr(e){let r="";return e.forEach(s=>{r+=s.value}),r}}class Ie extends mt{static prettifyToken(e,r,s){return e!=="func"&&e!=="command"&&e!=="other"?s:e=="command"?s+" ":Ie.PRETTIFY_REPL[s]||s}static getIndentOffset(e,r){return[0,0]}static getNewLineCountFunction(e,r,s){var i;return e.key!=="newLines"?[e,0]:[null,((i=e.value.match(/\r\n|\n|\r/g))==null?void 0:i.length)||0]}}Ie.PRETTIFY_REPL={"=":" = ","+":" + ","-":" - ","*":" * ","/":" / ",",":", ",to:" to ",step:" step ",and:" and ",or:" or ",fn:"fn ",then:" then "};class Ut extends ${constructor(e={}){const r={v2Identifier:[8e3,String.raw`  (?<identifier>[\w]{1,2})      // First max 2 chars
                                            (?<idExtra>[\w]*)             // Remaining are not used
                                            (?<idType>[$%]?)              // Type declaration: $ or %
                                            `],v2Label:[2e3,String.raw`^(?<whiteSpc3>\s*)(?<label>[\d]+)`],v2Command:[6e3,String.raw`(?<command>end|for|next|data|input#|input|dim|read|let|goto|run|if|restore|gosub|return|rem|stop|on|wait|load|save|verify|def|poke|print#|print|cont|list|clr|cmd|sys|open|close|get|new)`],v2Function:[6100,String.raw`(?<identifier2>[\w]{0,2})?(?<func>tab\(|to|fn|spc\(|then|not|step|and|or|sgn|int|abs|usr|fre|pos|sqr|rnd|log|exp|cos|sin|tan|atn|peek|len|str\$|val|asc|chr\$|left\$|right\$|mid\$)`],V2Operator:[6200,String.raw`(?<operator>[+\-*/^>=<])`],v2Sep:[7e3,String.raw`(?<commandSep>[:])`],v2Rem:[1e3,String.raw`(?<commandRem>rem)(?<rem>.*$)`],newLines:[3050,String.raw`(?<newLines>(\r\n|\n|\r)+)`],whiteSpace:[3100,String.raw`(?<whiteSpc>[\t \u00a0]+)`]},s=$.buildRxString([j.numInt,j.numFloat,j.strDQuote,"v2Identifier","v2Label","V2Operator","v2Command","v2Function","newLines","v2Sep","v2Rem","whiteSpace"],r),i={command:"CMD",commandRem:"CMD",func:"FUNC",strDQuote:"STR",label:"LABEL",floatNum:"NUM",intNum:"NUM",identifier:"VAR",identifier2:"VAR",idExtra:"EXTRA",idType:"FUNC",commandSep:"SEP",whiteSpc:"SPC",rem:"REM",other:"OTHER"},n=new Vt({rxPattern:s,mapper:i,htmlClassPrefix:"editor-style-",PrettifierClass:Ie});super(n)}getTokensFromMemory(e){const r=Ht.getTokensFromMemory(e);this.reset(),r.forEach(s=>{this.addToken(s.key,String(s.value),s.pos)})}tokenizeStr(e){this.tokenizeString(e)}}class B extends me{static stringEncoder(e){if(e.key=="other"&&e.value=="?")return[F.TTC_COMMAND_TOKENS.print];const r={tokens:F.TTC_STRING_TOKENS,normalConverter:z.textToPetscii},{byteArray:s,status:i,_invalidCodes:n}=Y.convertStringToBytes(e.repr,r);return i!=="OK"&&console.log(i),s}static cmdEncoder(e){return[F.TTC_COMMAND_TOKENS[e.repr]]}static encodeTextAsBytes(e){const r=new Ut;return r.tokenizeString(e),B.encodeTokens(r.tokens)}static encodeTokens(e){let r=2049;const s=[],i={nextAddr:0,line:null,data:[]};function n(){if(i.data.length>0){r+=i.data.length+5,i.nextAddr=r;const l=Object.assign({},i);s.push(l),i.data=[],i.nextAddr=0}}e.forEach(l=>{if(l.category=="LABEL"){n();const d=parseInt(l.value,10);i.line=d;return}const c=B.encoders[l.key]||B.encoders[l.category];if(c){const d=c(l);i.data.push(...d)}}),n();const o=[];return s.forEach(l=>{o.push(l.nextAddr&255,l.nextAddr>>8),o.push(l.line&255,l.line>>8),o.push(...l.data,0)}),o.push(0,0),o}}B.encoders={idType:B.stringEncoder,STR:B.stringEncoder,NUM:B.stringEncoder,VAR:B.stringEncoder,SEP:B.stringEncoder,CMD:B.cmdEncoder,FUNC:B.cmdEncoder,operator:B.cmdEncoder,OTHER:B.stringEncoder};class Os extends $t{constructor(){const e=new Pe({});super(e)}}const Es={Tokenizer:Ut,Prettifier:Ie,Parser:Os,Encoder:B,Decoder:Ht,Preprocessor:Ft};var Re;(function(t){t.BASIC_V2="BasicV2",t.BASIC_V2_verbose="BasicV2-verbose",t.GOLFBAS_short="GolfBasic",t.GOLFBAS_verbose="GolfBasic-verbose"})(Re||(Re={}));const Ns={[Re.BASIC_V2]:Es,[Re.GOLFBAS_short]:Mt,[Re.GOLFBAS_verbose]:Mt};class Ls{constructor(){return this.language="undefined",this.model={},this}usePredefinedLanguage(e){return this.language=e,this.model=Ns[e],this}defineLanguage(e){return this.language=e,this}}let D;var Qe=null;function Kt(t){t.slice(2),D.bus.memoryManager.ram.load(t.slice(2),t[0]+t[1]*256),[46,48,50].forEach(e=>{D.bus.cpu.write(e,(t.length>>8)+9)})}function Ds(){const t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept",".prg"),t.addEventListener("change",e=>{const r=new FileReader;r.addEventListener("load",s=>{var n;const i=r.result;t instanceof HTMLInputElement&&((n=t==null?void 0:t.files)!=null&&n.length)&&i instanceof ArrayBuffer&&Kt([...new Uint8Array(i)])}),r.readAsArrayBuffer(t==null?void 0:t.files[0])}),t.click(),t.remove()}function Ps(){D=new xs,D.init();const t=document.getElementById("canvas");t.tabIndex=5e3,t.addEventListener("keydown",o=>D.onKeyDown(o)),t.addEventListener("keyup",o=>D.onKeyUp(o)),t.addEventListener("focus",D.clearKeys.bind(D));const e=Zt,r=jt,s=Gt,i={romCharset:new xt(ot("charset")||e),kernal:new ut(ot("kernal")||r),basicRom:new ft(ot("basic")||s)};D.setROMS(i),D.cpu.cacheInstructions=!1;function n(){if(D.mainLoop(),D.cpu.error){const o=document.getElementById("canvas").getContext("2d");o==null||o.clearRect(0,0,o.canvas.width,o.canvas.height),o==null||o.fillText(D.cpu.error,20,20,o.canvas.width-40)}setTimeout(n,10)}return setTimeout(n,0),D}const K=Ps();K.state=we.STOPPED;const Is=()=>{const t=document.getElementById("canvas").getContext("2d");try{if(K.cpu.error)return;const e=K.bus.vic.imageData;t==null||t.putImageData(e,0,0)}catch(e){console.log(e)}},Xt=()=>{Is(),Vs(),requestAnimationFrame(Xt)};function Fs(){Qe||(Qe=new Ls().usePredefinedLanguage(Re.BASIC_V2).model.Encoder);const t=window.prompt("Paste basic program");if(Qe&&t){const e=Qe.encodeTextAsBytes(t);Kt([1,8,...new Uint8Array(e)])}}var Ot;(Ot=document.getElementById("load-btn"))==null||Ot.addEventListener("click",Ds);var Et;(Et=document.getElementById("loadbas-btn"))==null||Et.addEventListener("click",Fs);var Nt;(Nt=document.getElementById("render-btn"))==null||Nt.addEventListener("click",()=>{K.cpu.bus.clock.renderVIC()});var Lt;(Lt=document.getElementById("step-btn"))==null||Lt.addEventListener("click",()=>{K.state=we.STOPPED,K.renderManyInstructions.bind(K)(10)});var Dt;(Dt=document.getElementById("run-btn"))==null||Dt.addEventListener("click",()=>{K.state=we.RUNNING;const t=document.getElementById("overlay");t.style.visibility="hidden"});var Pt;(Pt=document.getElementById("reset-btn"))==null||Pt.addEventListener("click",()=>{K.state=we.STOPPED,K.restart();const t=document.getElementById("overlay");t.style.visibility="hidden",K.state=we.RUNNING});const Bs=document.getElementById("stats");function Vs(){const t=K.cpu;Bs.innerHTML=`
    PC: ${t.pc.toString(16)} | A: ${t.a.toString(16)} | X: ${t.x.toString(16)} | Y: ${t.y.toString(16)}
  `}function ot(t){const e=localStorage.getItem(t);if(!e)return null;const r=JSON.parse(e);return document.querySelector(`#${t} span`).textContent=r.name,r.data}function zs(t){const e=new TextDecoder().decode(t);return e.includes("CBM80")?"cart":e.includes("PRINT")||e.includes("GOTO")?"basic":[8187,8189,8191].every(r=>t[r]>=224&&t[r]<=255)?"kernal":"unknown"}function gt(t){document.querySelector(`#${t} button`).addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.accept=".bin,.rom",r.addEventListener("change",async()=>{var n;if(!((n=r.files)!=null&&n.length))return;const s=r.files[0],i=new Uint8Array(await s.arrayBuffer());if(t==="charset"&&i.length!==4096)return alert("Charset must be 4KB");if(t==="basic"||t==="kernal"){if(i.length!==8192)return alert(`${t} must be 8KB`);const o=zs(i);if(o!=t)return alert(`Expected ${t} but detected ${o}!`)}document.querySelector(`#${t} span`).textContent=s.name,localStorage.setItem(t,JSON.stringify({name:s.name,data:Array.from(i)})),t==="charset"&&(D.bus.memoryManager.romCharset=new xt(Array.from(i))),t==="kernal"&&(D.bus.memoryManager.kernal=new ut(Array.from(i))),t==="basic"&&(D.bus.memoryManager.basicRom=new ft(Array.from(i)))}),r.click()})}gt("basic");gt("kernal");gt("charset");requestAnimationFrame(Xt);
